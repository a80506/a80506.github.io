<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê∫´ÊøïÂ∫¶Áõ£ÊéßÁ≥ªÁµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
        }

        /* ÊöóËâ≤‰∏ªÈ°å (È†êË®≠) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            padding: 2vh 2vw;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            
            /* ÊöóËâ≤‰∏ªÈ°åËÆäÊï∏ */
            --bg: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #0f0f1a 100%);
            --text-color: #e0e0e0;
            --header-bg: rgba(20, 20, 40, 0.6);
            --header-border: rgba(0, 255, 255, 0.1);
            --header-shadow: rgba(0, 255, 255, 0.1);
            --title-gradient: linear-gradient(90deg, #00ffff, #00ff88, #00ffff);
            --update-time-color: #888;
            --card-bg: linear-gradient(145deg, rgba(25, 25, 50, 0.9), rgba(15, 15, 30, 0.9));
            --card-border: rgba(0, 255, 255, 0.2);
            --card-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            --card-hover-shadow: 0 20px 50px rgba(0, 255, 255, 0.2);
            --card-top-bar: linear-gradient(90deg, #00ffff, #00ff88);
            --room-name-color: #00ffff;
            --online-dot: #00ff88;
            --offline-dot: #555;
            --metric-bg: rgba(0, 0, 0, 0.3);
            --metric-border: rgba(255, 255, 255, 0.05);
            --metric-label-color: #888;
            --temp-color: #ff6b6b;
            --humid-color: #4ecdc4;
            --modal-overlay: rgba(0, 0, 0, 0.8);
            --modal-bg: linear-gradient(145deg, rgba(25, 25, 50, 0.98), rgba(15, 15, 30, 0.98));
            --modal-border: rgba(0, 255, 255, 0.3);
            --chart-bg: rgba(0, 0, 0, 0.3);
            --chart-grid: rgba(255, 255, 255, 0.05);
            
            background: var(--bg);
            color: var(--text-color);
        }

        /* ‰∫ÆËâ≤‰∏ªÈ°å */
        body.light-theme {
            --bg: #f5f7fa;
            --text-color: #333;
            --header-bg: #fff;
            --header-border: #e0e0e0;
            --header-shadow: rgba(0, 0, 0, 0.06);
            --title-gradient: linear-gradient(90deg, #5c6bc0, #42a5f5, #5c6bc0);
            --update-time-color: #888;
            --card-bg: #fff;
            --card-border: #e8e8e8;
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            --card-hover-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            --card-top-bar: linear-gradient(90deg, #5c6bc0, #42a5f5);
            --room-name-color: #5c6bc0;
            --online-dot: #4caf50;
            --offline-dot: #ccc;
            --metric-bg: #f8f9fa;
            --metric-border: #eee;
            --metric-label-color: #888;
            --temp-color: #e65100;
            --humid-color: #0288d1;
            --modal-overlay: rgba(0, 0, 0, 0.5);
            --modal-bg: #fff;
            --modal-border: #e0e0e0;
            --chart-bg: #f8f9fa;
            --chart-grid: rgba(0, 0, 0, 0.05);
            
            background: var(--bg);
            color: var(--text-color);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            width: 100%;
        }

        header {
            text-align: center;
            margin-bottom: clamp(15px, 3vh, 40px);
            padding: clamp(12px, 1.5vh, 20px);
            position: relative;
        }

        .theme-toggle {
            position: absolute;
            top: 50%;
            right: clamp(10px, 2vw, 20px);
            transform: translateY(-50%);
            background: var(--metric-bg);
            border: 1px solid var(--card-border);
            border-radius: 50%;
            width: clamp(32px, 5vh, 40px);
            height: clamp(32px, 5vh, 40px);
            font-size: clamp(1rem, 2vh, 1.2rem);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            transform: translateY(-50%) scale(1.1);
        }

        h1 {
            font-size: clamp(1.5rem, 4vh, 2.5rem);
            background: var(--title-gradient);
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient 3s ease infinite;
            margin-bottom: 10px;
        }

        @keyframes gradient {
            0%, 100% { background-position: 0% center; }
            50% { background-position: 100% center; }
        }

        .update-time {
            color: var(--update-time-color);
            font-size: clamp(0.75rem, 1.5vh, 0.9rem);
        }

        .outdoor-info {
            display: flex;
            justify-content: center;
            gap: clamp(15px, 3vw, 40px);
            margin-bottom: clamp(10px, 1.5vh, 20px);
            flex-wrap: wrap;
        }

        .outdoor-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: clamp(8px, 1.2vh, 12px) clamp(15px, 2vw, 25px);
            background: var(--metric-bg);
            min-width: 140px;
            border-radius: 30px;
            border: 1px solid var(--card-border);
        }

        .outdoor-icon {
            font-size: clamp(1rem, 2vh, 1.3rem);
        }

        .outdoor-label {
            font-size: clamp(0.7rem, 1.2vh, 0.85rem);
            color: var(--metric-label-color);
        }

        .outdoor-value {
            font-size: clamp(0.85rem, 1.5vh, 1rem);
            font-weight: 600;
            color: var(--text-color);
        }

        .outdoor-value.hot {
            color: #ff6b6b;
        }

        .outdoor-value.humid {
            color: #46a3ff;
        }

        .outdoor-value.pm-high {
            color: #ff9800;
        }

        .outdoor-value.pm-danger {
            color: #f44336;
        }

        .outdoor-item.clickable {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .outdoor-item.clickable:hover {
            transform: scale(1.05);
            border-color: var(--room-name-color);
        }

        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: clamp(10px, 2vh, 25px);
            max-width: 1200px;
            margin: 0 auto;
        }

        @media (max-width: 1000px) {
            .rooms-grid { 
                grid-template-columns: repeat(2, 1fr);
                max-width: 700px;
            }
        }

        @media (max-width: 500px) {
            .rooms-grid { grid-template-columns: 1fr; }
        }

        .room-mini-chart {
            margin-top: 10px;
            display: none;
        }

        @media (min-height: 600px) {
            .room-mini-chart { display: block; }
        }

        .room-mini-chart canvas {
            width: 100% !important;
            height: 80px !important;
        }

        .room-card {
            background: var(--card-bg);
            border-radius: clamp(10px, 2vh, 20px);
            padding: clamp(12px, 2vh, 25px);
            border: 1px solid var(--card-border);
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .room-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--card-top-bar);
        }

        .room-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-hover-shadow);
        }

        .room-name {
            font-size: clamp(1rem, 2vh, 1.3rem);
            color: var(--room-name-color);
            margin-bottom: clamp(10px, 1.5vh, 20px);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .status-dot {
            width: clamp(8px, 1.2vh, 10px);
            height: clamp(8px, 1.2vh, 10px);
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-dot.online {
            background: var(--online-dot);
            box-shadow: 0 0 10px var(--online-dot);
            animation: pulse 2s infinite;
        }

        .status-dot.offline {
            background: var(--offline-dot);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .offline-badge {
            font-size: clamp(0.6rem, 1vh, 0.7rem);
            background: rgba(255, 100, 100, 0.2);
            color: #ff6b6b;
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: auto;
        }

        .no-data-card { opacity: 0.5; }
        .no-data-card:hover { transform: none; }
        .no-data-card .room-name { color: #888; }

        .room-update-time {
            margin-top: clamp(8px, 1vh, 15px);
            text-align: center;
            font-size: clamp(0.6rem, 1vh, 0.75rem);
            color: var(--update-time-color);
        }

        .metrics {
            display: flex;
            gap: clamp(6px, 1vh, 20px);
        }

        .metric {
            flex: 1;
            text-align: center;
            padding: clamp(10px, 1.5vh, 20px) clamp(5px, 0.5vw, 15px);
            background: var(--metric-bg);
            border-radius: clamp(8px, 1.5vh, 15px);
            border: 1px solid var(--metric-border);
            overflow: hidden;
            min-width: 0;
        }

        .metric-icon {
            font-size: clamp(1.2rem, 3vh, 2rem);
            margin-bottom: clamp(5px, 1vh, 10px);
        }

        .metric-value {
            font-size: clamp(1.2rem, 3vh, 2rem);
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
        }

        .metric-label {
            font-size: clamp(0.65rem, 1.2vh, 0.85rem);
            color: var(--metric-label-color);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .temp .metric-value { color: var(--temp-color); }
        .humid .metric-value { color: var(--humid-color); }
        .no-data { color: #666; font-size: 1.5rem; }

        .loading {
            text-align: center;
            padding: 50px;
            color: var(--room-name-color);
            font-size: 1.2rem;
        }

        /* Modal Ê®£Âºè */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-overlay);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 2vh 2vw;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--modal-bg);
            border-radius: clamp(12px, 2vh, 20px);
            padding: clamp(15px, 2.5vh, 30px);
            border: 1px solid var(--modal-border);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: min(900px, 95vw);
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: clamp(15px, 2vh, 25px);
            flex-shrink: 0;
        }

        .modal-title {
            font-size: clamp(1.1rem, 2.5vh, 1.5rem);
            color: #ffd700;
        }

        body.light-theme .modal-title {
            color: var(--room-name-color);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--metric-label-color);
            font-size: clamp(1.5rem, 3vh, 2rem);
            cursor: pointer;
            transition: color 0.3s;
            line-height: 1;
        }

        .modal-close:hover { color: #ff6b6b; }

        .time-range-btns {
            display: flex;
            gap: 10px;
            margin-bottom: clamp(12px, 2vh, 20px);
            flex-shrink: 0;
        }

        .time-range-btn {
            padding: clamp(6px, 1vh, 10px) clamp(12px, 2vw, 20px);
            border: 1px solid var(--card-border);
            background: var(--metric-bg);
            color: var(--text-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: clamp(0.75rem, 1.3vh, 0.9rem);
            transition: all 0.2s ease;
        }

        .time-range-btn:hover {
            border-color: #ffd700;
        }

        .time-range-btn.active {
            background: #ffd700;
            color: #000;
            border-color: #ffd700;
        }

        body.light-theme .time-range-btn:hover {
            border-color: var(--room-name-color);
        }

        body.light-theme .time-range-btn.active {
            background: var(--room-name-color);
            color: #fff;
            border-color: var(--room-name-color);
        }

        .chart-container {
            background: var(--chart-bg);
            border-radius: clamp(8px, 1.5vh, 15px);
            padding: clamp(12px, 2vh, 20px);
            margin-bottom: clamp(10px, 1.5vh, 20px);
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .chart-container:last-child { margin-bottom: 0; }

        .chart-title {
            color: var(--metric-label-color);
            font-size: clamp(0.7rem, 1.3vh, 0.9rem);
            margin-bottom: clamp(8px, 1vh, 15px);
            text-transform: uppercase;
            letter-spacing: 1px;
            flex-shrink: 0;
        }

        .chart-container canvas {
            flex: 1;
            min-height: 0;
            max-height: clamp(120px, 25vh, 250px);
        }
</style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè† Êô∫ÊÖßÊ∫´ÊøïÂ∫¶Áõ£ÊéßÁ≥ªÁµ±</h1>
            <p class="update-time">ÊúÄÂæåÊõ¥Êñ∞: <span id="lastUpdate">ËºâÂÖ•‰∏≠...</span></p>
            <button class="theme-toggle" id="themeToggle" title="ÂàáÊèõ‰∏ªÈ°å">üåô</button>
        </header>
        
        <div class="outdoor-info">
            <div class="outdoor-item clickable" id="weatherItem">
                <span class="outdoor-icon">üå§Ô∏è</span>
                <span class="outdoor-label">Êà∂Â§ñ</span>
                <span class="outdoor-value" id="weatherValue">--</span>
            </div>
            <div class="outdoor-item clickable" id="pm25Item">
                <span class="outdoor-icon">üå´Ô∏è</span>
                <span class="outdoor-label">PM2.5</span>
                <span class="outdoor-value" id="pm25Value">--</span>
            </div>
        </div>
        
        <div class="outdoor-info">
            <div class="outdoor-item clickable" id="minerItem">
                <span class="outdoor-icon">‚õèÔ∏è</span>
                <span class="outdoor-label">Á§¶Ê©ü</span>
                <span class="outdoor-value" id="minerValue">--</span>
            </div>
            <div class="outdoor-item clickable" id="powerItem">
                <span class="outdoor-icon">‚ö°</span>
                <span class="outdoor-label">ÈôΩÂè∞ËÄóÈõª</span>
                <span class="outdoor-value" id="powerValue">--</span>
            </div>
        </div>
        
        <div class="rooms-grid" id="roomsGrid"></div>
        

    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">ÊàøÈñìË©≥ÊÉÖ</h2>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="time-range-btns">
                <button class="time-range-btn active" data-days="1">24 Â∞èÊôÇ</button>
                <button class="time-range-btn" data-days="3">3 Â§©</button>
                <button class="time-range-btn" data-days="7">7 Â§©</button>
                <button class="time-range-btn" data-days="14">14 Â§©</button>
            </div>
            <div class="chart-container">
                <div class="chart-title" id="tempChartTitle">üå°Ô∏è Ê∫´Â∫¶ËÆäÂåñ (24Â∞èÊôÇ)</div>
                <canvas id="tempChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title" id="humidChartTitle">üíß ÊøïÂ∫¶ËÆäÂåñ (24Â∞èÊôÇ)</div>
                <canvas id="humidChart"></canvas>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="config.js"></script>
    <script>
const API_URL = 'https://api.thingspeak.com/channels/72313/feeds.json?results=50';
const API_URL_HISTORY = 'https://api.thingspeak.com/channels/72313/feeds.json';
const API_URL_EXTRA = 'https://api.thingspeak.com/channels/565880/feeds.json';

const rooms = [
    { name: 'ÂÆ¢Âª≥', tempField: 'field1', humidField: 'field2' },
    { name: 'ÊàøÈñì', tempField: 'field3', humidField: 'field4' },
    { name: 'ÈôΩÂè∞', tempField: 'field5', humidField: 'field6' },
    { name: 'Êõ∏Êàø', tempField: 'field7', humidField: 'field8' }
];

let tempChart = null;
let humidChart = null;
let currentRoomIndex = null;
let currentDays = 1;
let cachedFeeds24h = null;
let cachedExtra24h = null;
let cachedExtraFull = null;
let currentModalType = null; // 'room', 'weather', 'pm25', 'miner', 'power'
let cachedFeedsFull = null;

function formatValue(value, unit) {
    if (value === null || value === undefined || value === '') {
        return '<span class="no-data">--</span>';
    }
    return `${parseFloat(value).toFixed(1)}${unit}`;
}

function formatDateTime(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleString('zh-TW', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit'
    });
}

function formatTime(dateStr) {
    const date = new Date(dateStr);
    const datePart = date.toLocaleString('en-US', { month: '2-digit', day: '2-digit' });
    const timePart = date.toLocaleString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
    return [datePart, timePart];
}

function hasData(value) {
    return value !== null && value !== undefined && value !== '';
}

function getLatestDataPerRoom(feeds) {
    const latestData = {}, latestTime = {};
    for (let i = feeds.length - 1; i >= 0; i--) {
        const feed = feeds[i];
        for (const room of rooms) {
            if (hasData(feed[room.tempField]) && !hasData(latestData[room.tempField])) {
                latestData[room.tempField] = feed[room.tempField];
                latestData[room.humidField] = feed[room.humidField];
                latestTime[room.name] = feed.created_at;
            }
        }
    }
    return { data: latestData, times: latestTime };
}

function createRoomCard(room, data, updateTime, index) {
    const temp = data[room.tempField];
    const humid = data[room.humidField];
    const hasRoomData = hasData(temp) || hasData(humid);
    const timeStr = updateTime ? formatDateTime(updateTime) : '';
    return `
        <div class="room-card ${hasRoomData ? '' : 'no-data-card'}" data-room-index="${index}">
            <div class="room-name">
                <span class="status-dot ${hasRoomData ? 'online' : 'offline'}"></span>
                ${room.name}
                ${hasRoomData ? '' : '<span class="offline-badge">Èõ¢Á∑ö</span>'}
            </div>
            <div class="metrics">
                <div class="metric temp">
                    <div class="metric-icon">üå°Ô∏è</div>
                    <div class="metric-value">${formatValue(temp, '¬∞C')}</div>
                    <div class="metric-label">Ê∫´Â∫¶</div>
                </div>
                <div class="metric humid">
                    <div class="metric-icon">üíß</div>
                    <div class="metric-value">${formatValue(humid, '%')}</div>
                    <div class="metric-label">ÊøïÂ∫¶</div>
                </div>
            </div>
            <div class="room-mini-chart">
                <canvas id="miniChart${index}"></canvas>
            </div>
            ${hasRoomData ? `<div class="room-update-time">Êõ¥Êñ∞: ${timeStr}</div>` : ''}
        </div>
    `;
}

function getRoomHistoryData(feeds, room, days) {
    const now = new Date();
    const startTime = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
    const filteredFeeds = feeds.filter(feed => {
        const feedTime = new Date(feed.created_at);
        return feedTime >= startTime && hasData(feed[room.tempField]);
    });
    const sampleRate = days === 1 ? 1 : days === 3 ? 3 : days === 7 ? 6 : 12;
    const labels = [], tempData = [], humidData = [];
    for (let i = 0; i < filteredFeeds.length; i += sampleRate) {
        const feed = filteredFeeds[i];
        labels.push(formatTime(feed.created_at));
        tempData.push(parseFloat(feed[room.tempField]));
        humidData.push(parseFloat(feed[room.humidField]));
    }
    return { labels, tempData, humidData };
}

function createChart(ctx, labels, data, color) {
    const isLight = document.body.classList.contains('light-theme');
    const gridColor = isLight ? 'rgba(0,0,0,0.08)' : 'rgba(255,255,255,0.05)';
    const textColor = isLight ? '#666' : '#888';
    return new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                borderColor: color,
                backgroundColor: color + '20',
                fill: true,
                tension: 0.5,
                borderWidth: 2,
                pointRadius: 1,
                pointHoverRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { color: textColor, maxTicksLimit: 8 }, grid: { color: gridColor } },
                y: { ticks: { color: textColor }, grid: { color: gridColor } }
            }
        }
    });
}

function renderChart(roomIndex, days) {
    const room = rooms[roomIndex];
    if (tempChart) { tempChart.destroy(); tempChart = null; }
    if (humidChart) { humidChart.destroy(); humidChart = null; }
    const feeds = days === 1 ? (cachedFeeds24h || cachedFeedsFull) : cachedFeedsFull;
    if (!feeds) return;
    const { labels, tempData, humidData } = getRoomHistoryData(feeds, room, days);
    const isLight = document.body.classList.contains('light-theme');
    tempChart = createChart(document.getElementById('tempChart').getContext('2d'), labels, tempData, isLight ? '#e65100' : '#ff6b6b');
    humidChart = createChart(document.getElementById('humidChart').getContext('2d'), labels, humidData, isLight ? '#0288d1' : '#4ecdc4');
    const timeLabel = days === 1 ? '24Â∞èÊôÇ' : `${days} Â§©`;
    document.getElementById('tempChartTitle').textContent = `üå°Ô∏è Ê∫´Â∫¶ËÆäÂåñ (${timeLabel})`;
    document.getElementById('humidChartTitle').textContent = `üíß ÊøïÂ∫¶ËÆäÂåñ (${timeLabel})`;
}

async function prefetch24hData() {
    try {
        const res = await fetch(`${API_URL_HISTORY}?results=500`);
        const json = await res.json();
        if (json.feeds) cachedFeeds24h = json.feeds;
    } catch (e) { console.error('Error prefetching 24h:', e); }
}

async function prefetchFullData() {
    try {
        const res = await fetch(`${API_URL_HISTORY}?results=6000`);
        const json = await res.json();
        if (json.feeds) cachedFeedsFull = json.feeds;
    } catch (e) { console.error('Error prefetching full:', e); }
}

async function showRoomDetail(roomIndex) {
    currentRoomIndex = roomIndex;
    currentModalType = 'room';
    currentDays = 1;
    
    // Á¢∫‰øùÊøïÂ∫¶ÂúñË°®È°ØÁ§∫
    document.getElementById('humidChart').parentElement.style.display = '';
    
    document.getElementById('modalTitle').textContent = `${rooms[roomIndex].name} - Ê≠∑Âè≤Êï∏Êìö`;
    document.getElementById('modalOverlay').classList.add('active');
    document.querySelectorAll('.time-range-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.days === '1'));
    if (cachedFeeds24h || cachedFeedsFull) {
        renderChart(roomIndex, 1);
    } else {
        await prefetch24hData();
        renderChart(roomIndex, 1);
    }
}

function closeModal() {
    document.getElementById('modalOverlay').classList.remove('active');
}

async function fetchData() {
    const grid = document.getElementById('roomsGrid');
    try {
        const res = await fetch(API_URL);
        const json = await res.json();
        if (json.feeds && json.feeds.length > 0) {
            const { data, times } = getLatestDataPerRoom(json.feeds);
            grid.innerHTML = rooms.map((room, index) => createRoomCard(room, data, times[room.name], index)).join('');
            document.querySelectorAll('.room-card').forEach(card => {
                card.addEventListener('click', () => showRoomDetail(parseInt(card.dataset.roomIndex)));
            });
            document.getElementById('lastUpdate').textContent = formatDateTime(json.feeds[json.feeds.length - 1].created_at);
            // Ê∏≤ÊüìËø∑‰Ω†ÂúñË°®
            renderMiniCharts();
        }
    } catch (e) {
        console.error('Error fetching data:', e);
        grid.innerHTML = '<div class="loading">Ë≥áÊñôËºâÂÖ•Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶</div>';
    }
}

function initTheme() {
    const saved = localStorage.getItem('theme');
    if (saved === 'light') {
        document.body.classList.add('light-theme');
        document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
    }
}

function toggleTheme() {
    document.body.classList.toggle('light-theme');
    const isLight = document.body.classList.contains('light-theme');
    document.getElementById('themeToggle').textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
    localStorage.setItem('theme', isLight ? 'light' : 'dark');
}

// ‰∫ã‰ª∂Á∂ÅÂÆö
document.getElementById('modalClose').addEventListener('click', closeModal);
document.getElementById('modalOverlay').addEventListener('click', (e) => { if (e.target.id === 'modalOverlay') closeModal(); });
document.getElementById('themeToggle').addEventListener('click', toggleTheme);
document.querySelectorAll('.time-range-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const days = parseInt(btn.dataset.days);
        if (days === currentDays) return;
        currentDays = days;
        document.querySelectorAll('.time-range-btn').forEach(b => b.classList.toggle('active', b.dataset.days === String(days)));
        
        if (currentModalType && currentModalType !== 'room') {
            renderExtraChart(currentModalType, days);
        } else if (currentRoomIndex !== null) {
            renderChart(currentRoomIndex, days);
        }
    });
});

// È°çÂ§ñË≥áÊñôÈªûÊìä‰∫ã‰ª∂
document.getElementById('weatherItem').addEventListener('click', () => showExtraDetail('weather'));
document.getElementById('pm25Item').addEventListener('click', () => showExtraDetail('pm25'));
document.getElementById('minerItem').addEventListener('click', () => showExtraDetail('miner'));
document.getElementById('powerItem').addEventListener('click', () => showExtraDetail('power'));

// Êà∂Â§ñÂ§©Ê∞£
async function fetchWeather() {
    try {
        const res = await fetch(`https://opendata.cwa.gov.tw/fileapi/v1/opendataapi/O-A0001-001?Authorization=${CONFIG.CWB_APIKEY}&downloadType=WEB&format=JSON`);
        const data = await res.json();
        const cities = ['Êñ∞Ëéä', '‰∏âÈáç', '‰∫îËÇ°', 'ËòÜÊ¥≤', 'ÊùøÊ©ã'];
        const stations = data.cwaopendata?.dataset?.Station || [];
        
        for (const city of cities) {
            const station = stations.find(s => s.StationName === city);
            if (station?.WeatherElement) {
                const temp = station.WeatherElement.AirTemperature;
                const humid = station.WeatherElement.RelativeHumidity;
                const obsTime = station.ObsTime?.DateTime;
                
                if (obsTime && Date.now() - Date.parse(obsTime) > 5400000) continue;
                if (temp && humid && parseFloat(temp) > -10 && parseFloat(humid) > 0) {
                    const el = document.getElementById('weatherValue');
                    el.textContent = `${city} ${temp}¬∞C ${parseInt(humid)}%`;
                    el.classList.remove('hot', 'humid');
                    if (parseInt(temp) >= 32) el.classList.add('hot');
                    else if (parseInt(humid) >= 80) el.classList.add('humid');
                    return;
                }
            }
        }
    } catch (e) { console.error('Error fetching weather:', e); }
}

// PM2.5
async function fetchPM25() {
    try {
        const res = await fetch(`https://data.moenv.gov.tw/api/v2/aqx_p_432?api_key=${CONFIG.MOENV_KEY}&format=JSON`);
        const data = await res.json();
        const cities = ['Êñ∞Ëéä', 'ÊûóÂè£', 'ËèúÂØÆ', '‰∫îËÇ°', 'ËòÜÊ¥≤', 'ÊùøÊ©ã'];
        
        for (const city of cities) {
            const record = data.records?.find(r => r.sitename === city && parseInt(r['pm2.5']) > 0);
            if (record) {
                const pm25 = parseInt(record['pm2.5']);
                const el = document.getElementById('pm25Value');
                el.textContent = `${city} ${pm25}`;
                el.classList.remove('pm-high', 'pm-danger');
                if (pm25 > 40) el.classList.add('pm-danger');
                else if (pm25 > 20) el.classList.add('pm-high');
                return;
            }
        }
    } catch (e) { console.error('Error fetching PM2.5:', e); }
}

// È°çÂ§ñË≥áÊñôÈ†êËºâ
async function prefetchExtra24h() {
    try {
        const res = await fetch(`${API_URL_EXTRA}?results=96`);
        const json = await res.json();
        if (json.feeds) {
            cachedExtra24h = json.feeds;
            updateExtraDisplay();
        }
    } catch (e) { console.error('Error prefetching extra 24h:', e); }
}

async function prefetchExtraFull() {
    try {
        const res = await fetch(`${API_URL_EXTRA}?results=1344`);
        const json = await res.json();
        if (json.feeds) cachedExtraFull = json.feeds;
    } catch (e) { console.error('Error prefetching extra full:', e); }
}

function updateExtraDisplay() {
    const feeds = cachedExtra24h || cachedExtraFull;
    if (!feeds || feeds.length === 0) return;
    const latest = feeds[feeds.length - 1];
    
    // Á§¶Ê©üË≥áË®ä
    const minerTemp = latest.field4;
    const minerHash = latest.field5;
    if (minerTemp && minerHash) {
        document.getElementById('minerValue').textContent = `${minerTemp}¬∞C / ${minerHash} GH`;
    }
    
    // ËÄóÈõªÈáè
    const power = latest.field6;
    if (power) {
        document.getElementById('powerValue').textContent = `${power} W`;
    }
}

// È°ØÁ§∫È°çÂ§ñË≥áÊñôÁöÑ Modal
function showExtraDetail(type) {
    currentModalType = type;
    currentDays = 1;
    
    const modal = document.getElementById('modalOverlay');
    const title = document.getElementById('modalTitle');
    const tempTitle = document.getElementById('tempChartTitle');
    const humidTitle = document.getElementById('humidChartTitle');
    const humidContainer = document.getElementById('humidChart').parentElement;
    
    const titles = {
        weather: 'Êà∂Â§ñÊ∫´ÊøïÂ∫¶ - Ê≠∑Âè≤Êï∏Êìö',
        pm25: 'PM2.5 - Ê≠∑Âè≤Êï∏Êìö',
        miner: 'Á§¶Ê©üË≥áË®ä - Ê≠∑Âè≤Êï∏Êìö',
        power: 'HS300 ËÄóÈõªÈáè - Ê≠∑Âè≤Êï∏Êìö'
    };
    
    title.textContent = titles[type];
    modal.classList.add('active');
    
    document.querySelectorAll('.time-range-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.days === '1');
    });
    
    renderExtraChart(type, 1);
}

function renderExtraChart(type, days) {
    if (tempChart) { tempChart.destroy(); tempChart = null; }
    if (humidChart) { humidChart.destroy(); humidChart = null; }
    
    const feeds = days === 1 ? (cachedExtra24h || cachedExtraFull) : cachedExtraFull;
    if (!feeds) return;
    
    const now = new Date();
    const startTime = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
    const filtered = feeds.filter(f => new Date(f.created_at) >= startTime);
    
    const labels = filtered.map(f => formatTime(f.created_at));
    const isLight = document.body.classList.contains('light-theme');
    const tempColor = isLight ? '#e65100' : '#ff6b6b';
    const humidColor = isLight ? '#0288d1' : '#4ecdc4';
    
    const tempCtx = document.getElementById('tempChart').getContext('2d');
    const humidCtx = document.getElementById('humidChart').getContext('2d');
    const humidContainer = document.getElementById('humidChart').parentElement;
    const tempTitle = document.getElementById('tempChartTitle');
    const humidTitle = document.getElementById('humidChartTitle');
    const timeLabel = days === 1 ? '24Â∞èÊôÇ' : `${days} Â§©`;
    
    if (type === 'weather') {
        humidContainer.style.display = '';
        tempTitle.textContent = `üå°Ô∏è Êà∂Â§ñÊ∫´Â∫¶ (${timeLabel})`;
        humidTitle.textContent = `üíß Êà∂Â§ñÊøïÂ∫¶ (${timeLabel})`;
        tempChart = createChart(tempCtx, labels, filtered.map(f => parseFloat(f.field1)), tempColor);
        humidChart = createChart(humidCtx, labels, filtered.map(f => parseFloat(f.field2)), humidColor);
    } else if (type === 'pm25') {
        humidContainer.style.display = 'none';
        tempTitle.textContent = `üå´Ô∏è PM2.5 (${timeLabel})`;
        tempChart = createChart(tempCtx, labels, filtered.map(f => parseFloat(f.field3)), '#ff9800');
    } else if (type === 'miner') {
        humidContainer.style.display = '';
        tempTitle.textContent = `üå°Ô∏è Á§¶Ê©üÊ∫´Â∫¶ (${timeLabel})`;
        humidTitle.textContent = `‚õèÔ∏è Á§¶Ê©üÁÆóÂäõ (${timeLabel})`;
        tempChart = createChart(tempCtx, labels, filtered.map(f => parseFloat(f.field4)), tempColor);
        humidChart = createChart(humidCtx, labels, filtered.map(f => parseFloat(f.field5)), '#e6a800');
    } else if (type === 'power') {
        humidContainer.style.display = 'none';
        tempTitle.textContent = `‚ö° HS300 ËÄóÈõªÈáè (${timeLabel})`;
        tempChart = createChart(tempCtx, labels, filtered.map(f => parseFloat(f.field6)), '#4ecdc4');
    }
}

// Ëø∑‰Ω†ÂúñË°®
let miniCharts = [null, null, null, null];

function renderMiniCharts() {
    if (!cachedFeeds24h && !cachedFeedsFull) return;
    const feeds = cachedFeeds24h || cachedFeedsFull;
    
    const isLight = document.body.classList.contains('light-theme');
    const gridColor = isLight ? 'rgba(0,0,0,0.08)' : 'rgba(255,255,255,0.05)';
    const tempColor = isLight ? '#e65100' : '#ff6b6b';
    const humidColor = isLight ? '#0288d1' : '#4ecdc4';
    
    const now = new Date();
    const startTime = new Date(now.getTime() - 24 * 60 * 60 * 1000);
    
    rooms.forEach((room, idx) => {
        if (miniCharts[idx]) { miniCharts[idx].destroy(); miniCharts[idx] = null; }
        
        const roomFeeds = feeds.filter(f => {
            const t = new Date(f.created_at);
            return t >= startTime && hasData(f[room.tempField]);
        });
        
        // ÈôçÊé°Ê®£
        const sampled = [];
        for (let i = 0; i < roomFeeds.length; i += 4) {
            sampled.push(roomFeeds[i]);
        }
        
        const labels = sampled.map(f => formatTime(f.created_at));
        const tempData = sampled.map(f => parseFloat(f[room.tempField]));
        const humidData = sampled.map(f => parseFloat(f[room.humidField]));
        
        const ctx = document.getElementById(`miniChart${idx}`)?.getContext('2d');
        if (!ctx) return;
        
        const chartContainer = document.getElementById(`miniChart${idx}`)?.parentElement;
        
        miniCharts[idx] = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [
                    {
                        label: 'Ê∫´Â∫¶',
                        data: tempData,
                        borderColor: tempColor,
                        backgroundColor: tempColor + '20',
                        fill: false,
                        tension: 0.5,
                        borderWidth: 1.5,
                        pointRadius: 0,
                        yAxisID: 'y'
                    },
                    {
                        label: 'ÊøïÂ∫¶',
                        data: humidData,
                        borderColor: humidColor,
                        backgroundColor: humidColor + '20',
                        fill: false,
                        tension: 0.5,
                        borderWidth: 1.5,
                        pointRadius: 0,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: {
                        position: 'left',
                        ticks: { color: tempColor, font: { size: 9 }, maxTicksLimit: 3 },
                        grid: { color: gridColor }
                    },
                    y1: {
                        position: 'right',
                        ticks: { color: humidColor, font: { size: 9 }, maxTicksLimit: 3 },
                        grid: { display: false }
                    }
                }
            }
        });
        
        // ÂúñË°®ËºâÂÖ•ÂÆåÊàêÂæåÈ°ØÁ§∫
        if (chartContainer) {
            setTimeout(() => chartContainer.classList.add('loaded'), 50);
        }
    });
}

// ÂàùÂßãÂåñ
initTheme();
fetchData();
fetchWeather();
fetchPM25();
prefetch24hData().then(() => { prefetchFullData(); });
prefetchExtra24h().then(() => { prefetchExtraFull(); });
setInterval(fetchData, 30000);
setInterval(() => { fetchWeather(); fetchPM25(); }, 10 * 60 * 1000);
setInterval(() => { prefetch24hData().then(() => prefetchFullData()); }, 5 * 60 * 1000);
setInterval(() => { prefetchExtra24h().then(() => prefetchExtraFull()); }, 5 * 60 * 1000);
    </script>
</body>
</html>
