<script>
    var rows = 4;
    var list_table = [
        { // [0] 第一列開始
            title: "其他",
            items: [
                { div: "", title: "Google Keep", url: "https://keep.google.com" },
                { div: "", title: "HackMD筆記", url: "https://hackmd.io/s/SJUOsEo8g" },
                { div: "", title: "Trello - ToDo", url: "https://trello.com/b/8Y9Z4fzu/todo" },
                { div: "", title: "My Urls", url: "https://hackmd.io/s/B19p-moUg" },
                { div: "", title: "Learning URL", url: "https://hackmd.io/zbIexlI5TmGqICOzKU0F2w" },
                { div: "", title: "帳戶清單", url: "https://docs.google.com/document/d/1HelciAITnbP-pqn82F1nzGnVughprQKhoJe74DDLLt4/edit" },
                { div: "", title: "Modify This Page", url: "https://github.com/a80506/a80506.github.io/blob/master/index.html" },
                { div: "", title: "YouTube", url: "https://www.youtube.com/" }
            ]
        },
        { // [1]
            title: "AI tools",
            items: [
                { div: "", title: "ChatGPT", url: "https://chat.openai.com/" },
                { div: "", title: "Perplexity", url: "https://www.perplexity.ai/" },
                { div: "", title: "ClaudeAI", url: "https://claude.ai/" },
                { div: "", title: "Grok", url: "https://www.grok.com/" },
                { div: "", title: "DeepSeek", url: "https://chat.deepseek.com/" },
                { div: "", title: "Copilot", url: "https://copilot.microsoft.com/" },
                { div: "", title: "Gemini", url: "https://gemini.google.com/app" },
            ]
        },
        { // [2]
            title: "重要資訊",
            items: [
                { div: "", title: "ToDoist", url: "https://app.todoist.com/app/upcoming" },
                { div: "", title: "帳戶清單", url: "https://docs.google.com/document/d/1HelciAITnbP-pqn82F1nzGnVughprQKhoJe74DDLLt4" },
                { div: "", title: "一週氣象", url: "https://www.cwa.gov.tw/V8/C/W/County/County.html?C=63" },
                { div: "", title: "即時天氣", url: "https://www.cwa.gov.tw/V8/C/W/OBS_Station.html?ID=C0ACA" },
                { div: "weather", title: "新莊：00.0°C, 00%", url: "" },
                { div: "pm25", title: "PM 2.5：0 ug/m3", url: "" },
                { div: "rain", title: "", url: "" },
            ]
        },
        { // [3]
            title: "總經/Crypto",
            items: [
                { div: "", title: "Woody twitter", url: "https://twitter.com/woody82343978" },
                { div: "", title: "Gareth Soloway", url: "https://twitter.com/garethsoloway" },
                { div: "", title: "Messari research", url: "https://messari.io/research" },
                { div: "", title: "BTC vs 金銅比", url: "https://www.macromicro.me/charts/54926/bi-te-bi-jin-tong-bi?share=0517317a270c7772d87a819ffae053c6aa956bebca8dcb5d86c346be0b68a5db" },
                { div: "", title: "逃頂指數", url: "https://www.coinglass.com/zh-TW/pro/i/MA" },
                { div: "", title: "ahr999指標", url: "https://www.coinglass.com/zh-TW/pro/i/ahr999" },
                { div: "", title: "貪婪&恐慌指數", url: "https://alternative.me/crypto/fear-and-greed-index/" },
            ]
        },
        { // [4] 第二列開始
            title: "加密貨幣",
            items: [
                { div: "ENA", title: "", url: "" },
                { div: "ORDI", title: "", url: "" },
                { div: "1000SATS", title: "", url: "" },
                { div: "AVA", title: "", url: "" },
                { div: "ZK", title: "", url: "" },
                { div: "ALT", title: "", url: "" },
                { div: "ADA", title: "", url: "" },
                { div: "DOT", title: "", url: "" }
            ]
        },
        { // [5]
            title: "股市資訊",
            items: [
                { div: "", title: "國際重要指數", url: "https://www.wantgoo.com/global" },
                { div: "", title: "Yahoo 大盤線圖", url: "https://tw.stock.yahoo.com/t/idx.php" },
                { div: "", title: "HiStock 大盤指標", url: "https://histock.tw/stock/tchart.aspx?no=0000&m=b" },
                { div: "IPO", title: "HiStock 股票申購", url: "https://histock.tw/stock/public.aspx" },
                { div: "", title: "TWSE 競拍公告", url: "https://www.twse.com.tw/zh/announcement/auction.html" },
                { div: "", title: "Investing 期貨", url: "https://www.investing.com/indices/indices-futures" },
                { div: "", title: "ETF淨值", url: "https://mis.twse.com.tw/stock/etf_nav.jsp?ex=tse" }
            ]
        },
        { // [6]
            title: "股市資訊",
            items: [
                { div: "", title: "三大法人-期貨", url: "http://www.taifex.com.tw/cht/3/futContractsDateExcel" },
                //{ div: "", title: "三大法人-選擇權", url: "http://www.taifex.com.tw/cht/3/optContractsDateExcel" },
                { div: "", title: "三大法人-現貨", url: "http://www.twse.com.tw/zh/page/trading/fund/BFI82U.html" },
                { div: "nasdaq", title: "外資買賣超", url: "https://fubon-ebrokerdj.fbs.com.tw/Z/ZG/ZGK_D.djhtm" },
                { div: "TSE", title: "", url: "" },
                { div: "STOCK_1", title: "", url: "" },
                { div: "STOCK_2", title: "", url: "" },
                { div: "STOCK_3", title: "", url: "" },
            ]
        },
        { // [7]
            title: "加密貨幣",
            items: [
                { div: "DOGE", title: "", url: "" },
                { div: "SHIB", title: "", url: "" },
                { div: "PEPE", title: "", url: "" },
                { div: "BONK", title: "", url: "" },
                { div: "PENGU", title: "", url: "" },
                { div: "SUI", title: "", url: "" },
                { div: "COOKIE", title: "", url: "" },
                { div: "ETHTVL", title: "", url: "" },
            ]
        },
        { // [8] 第三列開始
            title: "加密貨幣",
            items: [
                { div: "NEXO", title: "", url: "" },
                { div: "OP", title: "", url: "" },
                { div: "ARB", title: "", url: "" },
                { div: "PYTH", title: "", url: "" },
                { div: "FLOW", title: "", url: "" },
                { div: "PENDLE", title: "", url: "" },
                { div: "DOGS", title: "", url: "" },
                { div: "RENDER", title: "", url: "" },
            ]
        },
        { // [9]
            title: "加密貨幣",
            items: [
                { div: "time", title: "", url: "" },
                { div: "mining", title: "XNA mining", url: "https://explorer.neurai.org/address/NWZ2EWG4EuKycxGdsQU32yZ1BxSESo4eNG" },
                { div: "BTC", title: "BTC: 000 (+0%)", url: "" },
                { div: "ETH", title: "ETH: 000 (+0%)", url: "" },
                { div: "FIL", title: "", url: "" },
                { div: "SOL", title: "", url: "" },
                { div: "DOGE", title: "", url: "" },
                { div: "ETHBTC", title: "", url: "" },
            ]
        },
        { // [10]
            title: "加密貨幣",
            items: [

                { div: "", title: "Fuly.ai 放貸", url: "https://fuly.ai/dashboard/bitfinex" },
                { div: "SSV", title: "", url: "" },
                { div: "IO", title: "", url: "" },
                { div: "STX", title: "", url: "" },
                { div: "ZRO", title: "", url: "" },
                { div: "", title: "Alt-Coins", url: "coin.html" },
                { div: "XXXBTC", title: "Coinblock", url: "https://a80506.github.io/coinblock-w.html" },
            ]
        },
        { // [11]
            title: "即時資訊",
            items: [
                { div: "", title: "全部圖表", url: "sensor2.html" },
                { div: "living_room", title: "客廳：00°C, 00%", url: "" },
                { div: "room3", title: "書房：00°C, 00%", url: "" },
                { div: "room2", title: "陽台：00°C, 00%", url: "" },
                { div: "", title: "Crypto2025", url: "https://tinyurl.com/alexcrypto2025" },
                //                { div: "", title: "BTC Dominance", url: "https://tw.tradingview.com/chart/?symbol=CRYPTOCAP%3ABTC.D" },
                //                { div: "btc_etf_flow", title: "BTC ETF Flow", url: "https://farside.co.uk/btc/" },
                //                { div: "", title: "BTC 1Y HODL Wave", url: "https://www.lookintobitcoin.com/charts/1-year-hodl-wave/" },
                { div: "home_traffic", title: "Home Traffic", url: "https://thingspeak.com/channels/1729950" },
                { div: "XXX", title: "Coinblock", url: "https://a80506.github.io/coinblock-w.html" },
            ]
        }
    ];
</script>

<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Alex's index</title>
    <style type="text/css">
        body {
            font-size: 9pt;
            background-color: #000000;
        }

        table {
            border-collapse: collapse;
            border-color: #707070;
        }

        td {
            empty-cells: show;
            color: #FFFF00;
            text-align: center;
            border-color: #707070;
            height: 26;
        }

        td.title {
            font-weight: bolder;
            color: #000000;
            background-color: #FF9933;
        }

        a {
            color: #FFFF00;
        }

        a {
            text-decoration: none
        }

        a:hover {
            color: #707070;
        }

        .XXX,
        .XXXBTC {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            /* 將畫面分成4列 */
            height: 100%;
            /* 使用全部可視區域高度 */
            color: #808080;
            /* 設定文字顏色為白色 */
            grid-gap: 0;
            /* 取消格線 */
            font-size: 5pt;
        }

        .block {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .green-bg {
            background-color: green;
            /* 設定背景色為綠色 */
            color: #fff;
        }

        .red-bg {
            background-color: red;
            /* 設定背景色為紅色 */
            color: #000;
        }

        .green-bg2 {
            background-color: #669933;
            /* 設定背景色為綠色 */
            color: #fff;
        }

        .red-bg2 {
            background-color: #FF9797;
            /* 設定背景色為紅色 */
            color: #000;
        }

        .black-bg {
            background-color: black;
            /* 設定背景色為黑色 */
        }

        .green-text {
            color: #80FF00;
            /* 設定文字顏色為綠色 */
        }

        .red-text {
            color: red;
            /* 設定文字顏色為紅色 */
        }

        /* Todoist 漂浮視窗樣式 */
        .todoist-float-icon {
            position: fixed;
            top: 40px;
            right: 150px;
            width: 50px;
            height: 50px;
            background-color: #e44332;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .todoist-float-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        .todoist-float-icon::before {
            content: "✓";
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .todoist-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 220px;
            max-height: 500px;
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
            overflow: hidden;
        }

        .todoist-header {
            background-color: #e44332;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .todoist-close {
            cursor: pointer;
            font-size: 18px;
            color: white;
        }

        .todoist-content {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }

        .todoist-loading {
            text-align: center;
            padding: 20px;
            color: #ccc;
        }

        .todoist-error {
            text-align: center;
            padding: 20px;
            color: #ff6b6b;
        }

        .task-item {
            background-color: #3c3c3c;
            margin-bottom: 8px;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #e44332;
            transition: background-color 0.2s ease;
        }

        .task-item:hover {
            background-color: #4c4c4c;
        }

        .task-title {
            color: #fff;
            font-size: 14px;
            margin-bottom: 5px;
            line-height: 1.4;
        }

        .task-meta {
            font-size: 11px;
            color: #999;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-project {
            color: #e44332;
        }

        .task-priority {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
        }

        .priority-1 {
            background-color: #ff4757;
            color: white;
        }

        .priority-2 {
            background-color: #ffa502;
            color: white;
        }

        .priority-3 {
            background-color: #3742fa;
            color: white;
        }

        .priority-4 {
            background-color: #747d8c;
            color: white;
        }

        .task-due {
            color: #ffa502;
        }

        .task-due.overdue {
            color: #ff4757;
            font-weight: bold;
        }

        .no-tasks {
            text-align: center;
            padding: 30px;
            color: #999;
        }
    </style>
    <style type="text/css"></style>
</head>
<script src="https://code.jquery.com/jquery-1.12.4.min.js"
    integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="config.js"></script>

<body>
    <!-- Todoist 漂浮視窗 -->
    <div class="todoist-float-icon" id="todoistIcon"></div>
    <div class="todoist-panel" id="todoistPanel">
        <div class="todoist-header">
            <span>我的任務</span>
            <span class="todoist-close" id="todoistClose">×</span>
        </div>
        <div class="todoist-content" id="todoistContent">
            <div class="todoist-loading">載入中...</div>
        </div>
    </div>

    <script>
        var item_title = "";
        var item_url = "";
        var i, j;
        document.write("<table border=\"0\" width=\"100%\" height=\"100%\" align=\"center\" valign=\"center\"><tbody><tr><td>");
        document.write("<table border=\"0\" width=\"75%\" height=\"80%\" align=\"center\"><tbody>");
        document.write("<tr valign=\"top\">");
        for (i = 0; i < list_table.length; i++) {
            document.write("<td>");
            document.write("<table border=\"1\" width=\"180\" align=\"center\"><tbody>");
            document.write("<tr><td class=\"title\">" + list_table[i].title + "</td></tr>");

            for (j = 0; j < 8; j++) {
                if (j == 7 && i != 4 && i != 7 && i != 8 && i != 9)
                    continue;
                item_title = list_table[i].items[j].title;
                item_url = list_table[i].items[j].url;
                item_div = list_table[i].items[j].div;
                if (item_title == "")
                    item_title = "　";
                if (item_title == "XXX")
                    document.write("<tr><td><div class=\"container\"></div></td></tr>");
                else
                    document.write("<tr><td><div class=\"" + item_div + "\"><a href=\"" + item_url + "\">" + item_title + "</a></div></td></tr>");
            }

            document.write("</tbody></table>");
            document.write("</td>");

            if (i % rows == rows - 1) {
                document.write("</tr>");
                document.write("<tr valign=\"top\">");
            }
        }
        document.write("</tr>");
        document.write("</tbody></table>");
        document.write("</td></tr></tbody></table>");
    </script>
</body>

</html>

<script>
    var max = 20;
    var living_room_t = 0, living_room_h = 0;
    var room1_t = 0, room1_h = 0;
    var room2_t = 0, room2_h = 0;
    var room3_t = 0, room3_h = 0;
    var timestamp = 0;
    var fil_reward = 0, fil_storage = 0;

    function get_pm25() {
        $.getJSON("https://data.moenv.gov.tw/api/v2/aqx_p_432?api_key=" + CONFIG.MOENV_KEY + "&format=JSON",
            function (data) {
                const citiesToCheck = ["新莊", "林口", "菜寮", "五股", "蘆洲", "板橋"];
                let found = 0;
                let site = "";
                let pm25_str = "";

                for (const city of citiesToCheck) {
                    for (const record of data) {
                        if (record.sitename === city && parseInt(record["pm2.5"]) > 0) {
                            found = 1;
                            site = record.sitename;
                            pm25_str = record["pm2.5"];
                            break;
                        }
                    }
                    if (found)
                        break;
                }

                if (found) {
                    const pm25Value = parseInt(pm25_str);
                    const pm25Div = $("div.pm25");

                    if (pm25Value > 40) {
                        pm25Div.css("color", "red");
                        pm25Div.css("font-weight", "bold");
                    } else if (pm25Value > 20) {
                        pm25Div.css("color", "orange");
                        pm25Div.css("font-weight", "bold");
                    }

                    pm25Div.html(`${site} PM2.5：${pm25_str}`);
                }
            });
    }

    function change_weather_div(data, station) {
        if (data.ObsTime.DateTime != "") {
            timestamp = Date.parse(data.ObsTime.DateTime);
            if (Date.now() - timestamp > 5400000)
                return 0;
        }
        if (data.WeatherElement) {
            cwa_t = data.WeatherElement.AirTemperature;
            cwa_h = data.WeatherElement.RelativeHumidity;
            cwa_w = data.WeatherElement.Weather;

            if (cwa_t != "" && cwa_h != "" && parseFloat(cwa_t) > -10 && parseFloat(cwa_h) > 0) {
                $("div.weather").html(station + "：" + cwa_t + "°C, " + String(parseInt(cwa_h)) + "%");
                if (parseInt(cwa_h) >= 80) {
                    $("div.weather").css("color", "#46a3ff");
                    $("div.weather").css("font-weight", "bold");
                }
                if (parseInt(cwa_t) >= 32) {
                    $("div.weather").css("color", "red");
                    $("div.weather").css("font-weight", "bold");
                }
                return 1;
            }
        }
        return 0;
    }

    function get_weather_place(data, station) {
        for (var x in data.cwaopendata.dataset.Station) {
            if (data.cwaopendata.dataset.Station[x].StationName == station) {
                found = change_weather_div(data.cwaopendata.dataset.Station[x], station)
                if (found)
                    return 1;
            }
        }
        return 0;
    }

    function get_weather() {
        $.getJSON("https://opendata.cwa.gov.tw/fileapi/v1/opendataapi/O-A0001-001?Authorization=" + CONFIG.CWB_APIKEY + "&downloadType=WEB&format=JSON",
            function (data) {
                var found = 0;

                const cities = ["新莊", "三重", "五股", "蘆洲", "板橋"];

                for (const city of cities) {
                    if (get_weather_place(data, city)) {
                        return;
                    }
                }


            });
    }

    /* DHT22 Sensor */
    $.getJSON("https://api.thingspeak.com/channels/72313/feeds.json?results=" + String(max),
        function (data) {
            $.each(data, function (key, val) {
                if (key == "feeds") {
                    for (var i = 0; i < max; i++) {
                        if (Date.now() - Date.parse(val[i].created_at) > 1800000)
                            continue;
                        if (val[i].field1 && val[i].field2) {
                            living_room_t = parseInt(val[i].field1);
                            living_room_h = parseInt(val[i].field2);
                        } else if (val[i].field3 && val[i].field4) {
                            room1_t = parseInt(val[i].field3);
                            room1_h = parseInt(val[i].field4);
                        } else if (val[i].field5 && val[i].field6) {
                            room2_t = parseInt(val[i].field5);
                            room2_h = parseInt(val[i].field6);
                        } else if (val[i].field7 && val[i].field8) {
                            room3_t = parseInt(val[i].field7);
                            room3_h = parseInt(val[i].field8);
                        }
                    }

                    if (living_room_h == 0)
                        $("div.living_room").css("color", "pink");
                    else if (living_room_h >= 80)
                        $("div.living_room").css("color", "red");
                    else if (living_room_h >= 70)
                        $("div.living_room").css("color", "orange");

                    if (room1_h == 0)
                        $("div.room1").css("color", "pink");
                    else if (room1_h >= 80)
                        $("div.room1").css("color", "red");
                    else if (room1_h >= 70)
                        $("div.room1").css("color", "orange");

                    if (room2_h == 0)
                        $("div.room2").css("color", "pink");
                    else if (room2_h >= 90)
                        $("div.room2").css("color", "red");
                    else if (room2_h >= 80)
                        $("div.room2").css("color", "orange");

                    if (room3_h == 0)
                        $("div.room3").css("color", "pink");
                    else if (room3_h >= 80)
                        $("div.room3").css("color", "red");
                    else if (room3_h >= 70)
                        $("div.room3").css("color", "orange");

                    $("div.living_room").html("客廳：" + living_room_t + "°C, " + living_room_h + "%");
                    $("div.room1").html("主臥：" + room1_t + "°C, " + room1_h + "%");
                    $("div.room2").html("陽台：" + room2_t + "°C, " + room2_h + "%");
                    $("div.room3").html("書房：" + room3_t + "°C, " + room3_h + "%");
                }
            });
        });

    // FIL reward
    $.getJSON("https://api.thingspeak.com/channels/565880/feeds.json?results=" + String(max),
        function (data) {
            $.each(data, function (key, val) {
                if (key == "feeds") {
                    for (var i = 0; i < max; i++) {
                        if (parseFloat(val[i].field1) > 0) {
                            if (Date.now() - Date.parse(val[i].created_at) > 86400000)
                                continue;
                            fil_reward = parseFloat(val[i].field1);
                            if (parseFloat(val[i].field2) > 0) {
                                if (Date.now() - Date.parse(val[i].created_at) > 86400000)
                                    continue;
                                fil_storage = parseFloat(val[i].field2);
                            }
                        }
                        $("div.fil_reward1").html("FIL: " + fil_storage.toFixed(2) + " / " + fil_reward);
                    }
                }
            });
        });

    // Stock
    $.getJSON("https://api.thingspeak.com/channels/72839/feeds.json?results=" + String(max),
        function (data) {
            var f1 = 0, f2 = 0, f3 = 0, f4 = 0, f5 = 0, f6 = 0, f7 = 0, f8 = 0;
            var json_len = 0;
            $.each(data, function (key, val) {
                if (key == "feeds") {
                    for (var i = 0; i < max; i++) {
                        if (Date.now() - Date.parse(val[i].created_at) > 86400000)
                            continue;
                        if (val[i].field1)
                            f1 = parseInt(val[i].field1);
                        if (val[i].field2)
                            f2 = parseInt(val[i].field2);
                        if (val[i].field3)
                            f3 = parseFloat(val[i].field3);
                        if (val[i].field4)
                            f4 = parseFloat(val[i].field4);
                        if (val[i].field5)
                            f5 = parseFloat(val[i].field5);
                        if (val[i].field6)
                            f6 = parseFloat(val[i].field6);
                        if (val[i].field7)
                            f7 = parseFloat(val[i].field7);
                        if (val[i].field8)
                            f8 = parseFloat(val[i].field8);
                    }
                    var sign1 = '', sign2 = '', sign3 = '', sign4 = '';
                    var color1 = '', color2 = '', color3 = '', color4 = '';


                    if (f2 < 0) {
                        color1 = 'style="color: red;"';
                    } else {
                        sign1 = '+';
                        color1 = 'style="color: #80FF00;"';
                    }
                    if (f4 < 0) {
                        color2 = 'style="color: red;"';
                    } else {
                        sign2 = '+';
                        color2 = 'style="color: #80FF00;"';
                    }
                    if (f6 < 0) {
                        color3 = 'style="color: red;"';
                    } else {
                        sign3 = '+';
                        color3 = 'style="color: #80FF00;"';
                    }

                    if (f8 < 0) {
                        color4 = 'style="color: red;"';
                    } else {
                        sign4 = '+';
                        color4 = 'style="color: #80FF00;"';
                    }

                    $("div.TSE").html("<a href='https://tw.stock.yahoo.com/t/idx.php' " + color1 + " >" + f1.toString() + ", " + sign1 + f2.toString() + ", " + sign1 + (f2 / (f1 - f2) * 100).toFixed(2).toString() + "%</a>");
                    $("div.STOCK_1").html("<a href='https://tw.stock.yahoo.com/quote/00637L/technical-analysis' " + color2 + " >" + f3.toFixed(2).toString() + ", " + sign2 + f4.toFixed(2).toString() + ", " + sign2 + (f4 / (f3 - f4) * 100).toFixed(2).toString() + "%</a>");
                    $("div.STOCK_2").html("<a href='https://tw.stock.yahoo.com/quote/7547/technical-analysis' " + color3 + " >" + f5.toFixed(2).toString() + ", " + sign3 + f6.toFixed(2).toString() + ", " + sign3 + (f6 / (f5 - f6) * 100).toFixed(2).toString() + "%</a>");
                    $("div.STOCK_3").html("<a href='https://tw.stock.yahoo.com/quote/2408/technical-analysis' " + color4 + " >" + f7.toFixed(2).toString() + ", " + sign4 + f8.toFixed(2).toString() + ", " + sign4 + (f8 / (f7 - f8) * 100).toFixed(2).toString() + "%</a>");
                }
            });
        });

    /* Air Sensor */
    /*
    $.getJSON("https://api.thingspeak.com/channels/72839/feeds.json?results=" + String(max),
        function (data) {
            $.each(data, function (key, val) {
                if (key == "feeds") {
                    for (var i = 0; i < max; i++) {
                        if (Date.now() - Date.parse(val[i].created_at) > 1800000)
                            continue;
                        if (val[i].field2) {
                            pm25 = parseInt(val[i].field2);
                            break;
                        }
                    }

                    if (pm25 == -1)
                        return;
                    else if (pm25 >= 40)
                        $("div.pm25").css("color", "red");
                    else if (pm25 >= 20)
                        $("div.pm25").css("color", "orange");

                    $("div.pm25").html("PM 2.5：" + pm25 + " ug/m3");
                }
            });
        });

    /* Miner */
    /*
    $.getJSON("https://gpumine.org/api/miner?currency=ETH&address=0x9d96b087a6279f5b5967804b1c2c3d6952e6f531",
    function (data) {
        var exist1 = data['data']['workers']['list'][0].online;
        var miner1 = parseInt(100 * data['data']['workers']['list'][0].hashrate24h / data['data']['workers']['list'][0].submitHashrate24h);
        var hashrate1 = (parseFloat(data['data']['workers']['list'][0].hashrate24h) / 1000000).toFixed(1);
        var exist2 = data['data']['workers']['list'][1].online;
        var miner2 = parseInt(100 * data['data']['workers']['list'][1].hashrate24h / data['data']['workers']['list'][1].submitHashrate24h);
        var hashrate2 = (parseFloat(data['data']['workers']['list'][1].hashrate24h) / 1000000).toFixed(1);
        var color2 = "#80FF00";

        if (exist1 == 0 || miner1 < 90) {
            $("div.miner1").css("color", "red");
            $("div.miner1").css("font-weight", "bold");
        } else if (miner1 < 95) {
            $("div.miner1").css("color", "orange");
        }

        if (exist2 == 0 || miner2 < 90) {
            $("div.miner2").css("color", "red");
            $("div.miner2").css("font-weight", "bold");
            color2 = "red";
        } else if (miner2 < 95) {
            $("div.miner2").css("color", "orange");
        }

        if (exist1)
            $("div.miner1").html("Miner1: " + hashrate1 + "M, " + miner1 + "%");
        else
            $("div.miner1").html("Miner1: Leaved....");

        if (exist2 && miner2 >= 90)
            $("div.miner2").html("<a style=\"color:" + color2 + ";\" href=\"http://hks.hiveos.farm/\">Miner2: " + hashrate2 + "M, " + miner2 + "%</a>");
        else if (exist2)
            $("div.miner2").html("Miner2: " + hashrate2 + "M, " + miner2 + "%");
        else
            $("div.miner2").html("Miner2: Leaved....");
    });


    $.getJSON("https://gpumine.org/api/bill?currency=ETH&address=0x9d96b087a6279f5b5967804b1c2c3d6952e6f531",
    function (data) {
        var reward1d = parseFloat(data['data']['calcReward24h'].coin).toFixed(4);
        var reward1d_usd = parseInt(data['data']['calcReward24h'].usd);
        var reward1d_twd = parseInt(data['data']['calcReward24h'].ntd);
        var reward1m = (reward1d * 30).toFixed(3);
        var reward1m_usd = parseInt(reward1d_usd * 30);
        var reward1m_twd = reward1d_twd * 30;
        var balance = parseFloat(data['data'].balance);


        if (reward1d > 0) {
            $("div.miner_1d").html(reward1d + " / " + reward1d_usd + "U / " + reward1d_twd);
        } else {
            $("div.miner_1d").css("color", "red")
            $("div.miner_1d").html("no data");
        }

        if (reward1m > 0) {
            $("div.miner_1m").html(reward1m + " / " + reward1m_usd + "U / " + reward1m_twd + "");
        } else {
            $("div.miner_1m").css("color", "red")
            $("div.miner_1m").html("no data");
        }

        if (balance > 0) {
            var d = new Date();
            var last_hour = parseInt((0.1-balance)/reward1d*24);
            var day = parseInt(last_hour/24);

            if (balance > 0.9)
                $("div.balance").css("color", "orange");

            if (last_hour > 24) {
                if (d.getHours() + last_hour%24 >= 15)
                    day = day+1;
                $("div.balance").html(balance.toFixed(5) + " / " + day + "D " + (last_hour % 24+1) + "H");
            } else if (last_hour > 0) {
                $("div.balance").html(balance.toFixed(5) + " / " + last_hour.toString() + "H");
            } else if (reward1d > 0) {
                if (d.getHours() <= 15)
                    $("div.balance").html(balance.toFixed(5) + " / Today");
                else
                    $("div.balance").html(balance.toFixed(5) + " / Tomorrow");
            } else {
                    $("div.balance").html(balance.toFixed(5));
            }
        }
    });
*/

    function get_eth_gas() {
        var gas = 0;
        var color = "#80FF00";
        $.getJSON("https://api.gasprice.io/v1/estimates",
            function (data) {
                gas = parseFloat(data.result.baseFee);
                if (gas > 60)
                    color = "red";
                else if (gas > 40)
                    color = "orange";
                $("div.GAS").html("<a style=\"color:" + color + ";\" href=\"https://www.gasprice.io/\">" + "ETH Gas: " + parseInt(gas).toString() + "</a>");
            }
        );
    }

    function get_geckoterminal(pool) {
        var price = 0;
        var item = "";
        if (pool == "0xfb79d843d8d7e38bd5a7f115fa889b043db6fe76") {
            item = "MCC";
            $.getJSON("https://api.geckoterminal.com/api/v2/networks/bsc/pools/" + pool,
                function (data) {
                    price = parseFloat(data.data.attributes.base_token_price_usd);
                    if (price > 0.08)
                        $("div." + item).html("<a href='https://www.geckoterminal.com/bsc/pools/" + pool + "'>" + item + ": " + price.toFixed(4).toString() + "</a>");
                }
            );
        }
        if (pool == "0x09ead9122ba8ac230746eb9730d1c099d9a6181d") {
            item = "WCC";
            $.getJSON("https://api.geckoterminal.com/api/v2/networks/bsc/pools/" + pool,
                function (data) {
                    price = parseFloat(data.data.attributes.base_token_price_usd);
                    if (price > 0.015)
                        $("div." + item).html("<a href='https://www.geckoterminal.com/bsc/pools/" + pool + "'>" + item + ": " + price.toFixed(4).toString() + "</a>");
                }
            );
        }
    }

    function get_binance(item) {

        var percent = 0;
        var percent_html = "";

        if (item == "ETHBTC" || item == "FILBTC" || item == "LINKBTC" || item == "APEBTC" || item == "UNIBTC") {
            $.getJSON("https://api.binance.com/api/v3/ticker/24hr?symbol=" + item,
                function (data) {
                    var color = "#80FF00";
                    percent = parseInt(data.priceChangePercent);
                    if (percent < 0) {
                        color = "red";
                        percent_html = " (" + percent.toString() + "%)";
                    } else if (percent > 0) {
                        percent_html = " (+" + percent.toString() + "%)";
                    } else {
                        color = "yellow";
                    }

                    //                    if (item == "ETHBTC") {
                    //                        price = parseFloat(data.lastPrice).toFixed(3);
                    //                        $("div." + item.toUpperCase()).html("<a style=\"color:" + color + ";\" href=\"https://www.binance.com/zh-TW/trade/" + item + "_USDT\">" + item.toUpperCase()+ ": " + String(price) + percent_html + "</a>");
                    //                    } else {
                    price = parseFloat(data.lastPrice).toFixed(5);
                    $("div." + item.toUpperCase()).html("<a style=\"color:" + color + ";\" href=\"https://www.binance.com/zh-TW/trade/" + item + "\">" + item.toUpperCase() + ": " + String(price) + "</a>");
                    //                    }
                }
            );
            return;
        }

        $.getJSON("https://api.binance.com/api/v3/ticker/24hr?symbol=" + String(item).toUpperCase() + "USDT",
            function (data) {
                var color = "#80FF00";
                var percent = 0;
                var price = 0;

                percent = parseInt(data.priceChangePercent);
                if (percent < 0) {
                    color = "red";
                    percent_html = " (" + percent.toString() + "%)";
                } else if (percent > 0) {
                    percent_html = " (+" + percent.toString() + "%)";
                    percent_html = " (+" + percent.toString() + "%)";
                } else {
                    color = "yellow";
                }

                price = parseFloat(data.lastPrice);
                if (price >= 100)
                    price = parseInt(data.lastPrice);
                else if (price >= 1)
                    price = parseFloat(data.lastPrice).toFixed(2);
                else
                    price = parseFloat(data.lastPrice).toFixed(3);


                if (item == "BLUR")
                    $("div.MCC").html("<a style=\"color:" + color + ";\" href=\"https://www.binance.com/zh-TW/trade/" + item + "_USDT\">" + item.toUpperCase() + ": " + String(price) + percent_html + "</a>");
                else
                    $("div." + item.toUpperCase()).html("<a style=\"color:" + color + ";\" href=\"https://www.binance.com/zh-TW/trade/" + item + "_BTC\">" + item.toUpperCase() + "</a>" + "<a style=\"color:" + color + ";\" href=\"https://www.binance.com/zh-TW/trade/" + item + "_USDT\">" + ": " + String(price) + percent_html + "</a>");
                //$("div." + item.toUpperCase()).html("<a style=\"color:" + color + ";\" href=\"https://www.binance.com/zh-TW/trade/" + item + "_USDT\">" + item.toUpperCase()+ ": " + String(price) + percent_html + "</a>");
            }
        );
    }

    function get_binance_cmc(item, slug) {

        var percent = 0;
        var percent_html = "";

        $.getJSON("https://www.binance.com/bapi/composite/v1/public/promo/cmc/cryptocurrency/quotes/latest?symbol=" + item,

            function (data) {
                var color = "#80FF00";
                var percent = 0;
                var price = 0;
                var name = "";
                var i = 0;

                $.each(data.data.body.data, function (key, val) {
                    if (key == item) {

                        i = 0;
                        while (val[i].slug.length > 0) {
                            if (slug == val[i].slug)
                                break;
                            i = i + 1;
                        }

                        percent = parseInt(val[i].quote.USD.percent_change_24h);
                        if (percent < 0) {
                            color = "red";
                            percent_html = " (" + percent.toString() + "%)";
                        } else if (percent > 0) {
                            percent_html = " (+" + percent.toString() + "%)";
                        } else {
                            color = "yellow";
                        }

                        price = parseFloat(val[i].quote.USD.price);
                        if (price >= 100)
                            price = parseInt(price);
                        else if (price >= 1)
                            price = parseFloat(price).toFixed(2);
                        else if (price >= 0.01)
                            price = parseFloat(price).toFixed(3);
                        else if (price >= 0.001)
                            price = parseFloat(price).toFixed(4);
                        else if (price >= 0.0001)
                            price = parseFloat(price).toFixed(5);
                        else
                            price = parseFloat(price).toFixed(6);

                        name = val[i].slug
                        $("div." + item.toUpperCase()).html("<a style=\"color:" + color + ";\" href=\"https://www.binance.com/en/price/" + name + "\">" + item.toUpperCase() + ": " + String(price) + percent_html + "</a>");
                    }
                });
            }
        );
    }

    function set_time() {
        var d = new Date();
        $("div.time").css("color", "orange");
        $("div.time").html((d.getMonth() + 1) + "/" + d.getDate() + " " + d.toLocaleTimeString("en-US", { hour12: false, hour: "2-digit", minute: "2-digit" }));
        setTimeout(function () { set_time(); }, 1000);
    }

    $("div.mining").html("<font color=\"#80FF00\">Mining: <a href='https://explorer.neurai.org/address/NWZ2EWG4EuKycxGdsQU32yZ1BxSESo4eNG'>XNA</a> / <a href='https://explorer.neoxa.net/address/GTY1YPNYGXX1WxqGQFgCK1znqUmcu7wtZA'>NEOX</a></font>");
    var coinOrder = [
        'BTC', 'ETH', 'SOL', 'BNB',
        'STX', 'ORDI', '1000SATS', 'RIF',
        'ARB', 'OP', 'STRK', 'XAI',
        'LINK', 'PYTH', 'TIA', 'BAND',
        'DOT', 'ATOM', 'FIL', 'AR',
        'BLUR', 'UNI', 'DYDX', 'JUP',
        'STG', 'ALT', 'MANTA', 'MATIC',
        'SSV', 'PENDLE', 'MAGIC', 'WLD',
        'FLOW', 'NEXO', 'APE', 'MEME',
        'PEPE', 'DOGE', 'SHIB', 'BONK'
    ];


    function fetchAndUpdate() {
        var container = document.querySelector('.XXX');
        container.innerHTML = ''; // 清空容器內的內容

        var promises = coinOrder.map(function (coin) {
            return fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=' + coin + 'USDT')
                .then(response => response.json())
                .then(data => {
                    // 創建區塊
                    var block = document.createElement('div');
                    block.className = 'block';
                    var priceChangePercent = parseFloat(data.priceChangePercent);
                    if (priceChangePercent < -10) {
                        block.classList.add('red-bg', 'black-text');
                    } else if (priceChangePercent < -5) {
                        block.classList.add('red-bg2', 'black-text');
                    } else if (priceChangePercent > 10) {
                        block.classList.add('green-bg', 'black-text');
                    } else if (priceChangePercent > 5) {
                        block.classList.add('green-bg2', 'black-text');
                    } else if (priceChangePercent > 1) {
                        block.classList.add('black-bg', 'green-text');
                    } else if (priceChangePercent < -1) {
                        block.classList.add('black-bg', 'red-text');
                    }

                    var percent_str = priceChangePercent.toFixed(1).toString() + "%";
                    if (priceChangePercent > 0)
                        percent_str = "+" + percent_str;
                    // 移除價格末尾多餘的零，並移除百分比
                    var price = parseFloat(data.lastPrice);
                    if (price >= 100)
                        price = parseInt(price);
                    else if (price >= 1)
                        price = price.toFixed(2);
                    else if (price >= 0.01)
                        price = price.toFixed(4);
                    else
                        price = price.toFixed(6);
                    coin = coin.replace("1000", "");
                    // 更新區塊內容
                    if (priceChangePercent < 1 && priceChangePercent > -1)
                        block.innerHTML = `<center><div><a href="sensor3.html">${coin}</a></div></center>`;
                    else
                        block.innerHTML = `<center><div>${coin}</div></center>`;
                    return block;
                })
                .catch(error => {
                    console.error('Error fetching ' + coin + ' price:', error);
                    return null;
                });
        });

        Promise.all(promises)
            .then(blocks => {
                blocks.forEach(block => {
                    if (block) {
                        container.appendChild(block);
                    }
                });
            });
    }

    function fetchAndUpdateBTC() {
        var container = document.querySelector('.XXXBTC');
        container.innerHTML = ''; // 清空容器內的內容

        var promises = coinOrder.map(function (coin) {
            return fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=' + coin + 'BTC')
                .then(response => response.json())
                .then(data => {
                    // 創建區塊
                    var block = document.createElement('div');
                    block.className = 'block';
                    var priceChangePercent = parseFloat(data.priceChangePercent);
                    if (priceChangePercent < -10) {
                        block.classList.add('red-bg', 'black-text');
                    } else if (priceChangePercent < -5) {
                        block.classList.add('red-bg2', 'black-text');
                    } else if (priceChangePercent > 10) {
                        block.classList.add('green-bg', 'black-text');
                    } else if (priceChangePercent > 5) {
                        block.classList.add('green-bg2', 'black-text');
                    } else if (priceChangePercent > 1) {
                        block.classList.add('black-bg', 'green-text');
                    } else if (priceChangePercent < -1) {
                        block.classList.add('black-bg', 'red-text');
                    }

                    var percent_str = priceChangePercent.toFixed(1).toString() + "%";
                    if (priceChangePercent > 0)
                        percent_str = "+" + percent_str;
                    // 移除價格末尾多餘的零，並移除百分比
                    var price = parseFloat(data.lastPrice);
                    if (price >= 100)
                        price = parseInt(price);
                    else if (price >= 1)
                        price = price.toFixed(2);
                    else if (price >= 0.01)
                        price = price.toFixed(4);
                    else
                        price = price.toFixed(6);
                    coin = coin.replace("1000", "");
                    // 更新區塊內容
                    if (priceChangePercent < 1 && priceChangePercent > -1)
                        block.innerHTML = `<center><div><a href="sensor3.html">${coin}</a></div></center>`;
                    else
                        block.innerHTML = `<center><div>${coin}</div></center>`;
                    return block;
                })
                .catch(error => {
                    console.error('Error fetching ' + coin + ' price:', error);
                    var block = document.createElement('div');
                    block.className = 'block';
                    block.innerHTML = ``;
                    return block
                });
        });

        Promise.all(promises)
            .then(blocks => {
                blocks.forEach(block => {
                    if (block) {
                        container.appendChild(block);
                    }
                });
            });
    }

    // Nasdaq Futures
    async function fetchNasdaqData(url, targetDivId) {
        const nasdaqDataElement = document.getElementById(targetDivId);

        try {
            // Fetch the JSON data
            const response = await fetch(url);

            // Check if the response is OK
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // Parse the JSON
            const data = await response.json();

            // Calculate time difference
            const dataTime = new Date(data.time);
            const currentTime = new Date();
            const timeDiffSeconds = Math.round((currentTime - dataTime) / 1000);

            // Show alert with time difference
            //alert(`數據時間距離現在約 ${timeDiffSeconds} 秒`);
            var status = '';
            if (timeDiffSeconds > 1800)
                status = '*';
            if (data.price_change > 0) {
                $("div.nasdaq").css("color", "#80FF00");
                $("div.nasdaq").html(data.latest_price.toString() + ", +" + data.price_change.toString() + ", +" + data.price_change_percent.toString() + "% " + status);
            } else {
                $("div.nasdaq").css("color", "red");
                $("div.nasdaq").html(data.latest_price.toString() + ", " + data.price_change.toString() + ", " + data.price_change_percent.toString() + "% " + status);
            }
            //<div class="nasdaq" id="nasdaqDataContainer" align="center"></div>
            //$("div.nasdaqDataContainer").html(data.latest_price.toString() + " / " );
        } catch (error) {
            // Handle any errors
            $("div.nasdaq").html("No data");
            console.error('Fetch error:', error);
        }
    }

    function fetchEthereumTVL() {
        try {
            var url = "https://api.llama.fi/v2/chains";
            var xhr = new XMLHttpRequest();
            xhr.open("GET", url, false); // false 表示同步請求
            xhr.send();

            if (xhr.status !== 200) {
                console.log("Error: 無法取得資料，狀態碼 " + xhr.status);
                return null;
            }

            var chainsData = JSON.parse(xhr.responseText);
            for (var i = 0; i < chainsData.length; i++) {
                if (chainsData[i].name.toLowerCase() === "ethereum") {
                    var tvl = chainsData[i].tvl / 1e9; // 轉成十億美元
                    if (tvl < 80)
                        $("div.ETHTVL").css("color", "orange");
                    else if (tvl < 75)
                        $("div.ETHTVL").css("color", "red");

                    $("div.ETHTVL").html("ETH TVL: " + tvl.toFixed(2).toString());
                    console.log("TVL: " + tvl.toFixed(2));
                    //return tvl.toFixed(2);
                }
            }

            console.log("Error: 在資料中找不到 Ethereum");
            //return null;

        } catch (e) {
            console.log("發生錯誤：" + e.toString());
            //return null;
        }
    }

    $("div.IPO").html("<a href='https://histock.tw/stock/public.aspx' style='color: #80FF00';>HiStock 股票申購</a>");
    $("div.btc_etf_flow").html("<a href='https://farside.co.uk/btc/' style='color: #80FF00';>BTC ETF Flow</a>");

    fetchEthereumTVL();
    set_time();
    fetchNasdaqData('https://' + CONFIG.MYSITE + '/linepic/nasdaq.json', 'nasdaq');
    get_binance("PENGU");
    get_binance("ADA");
    get_binance("DOT");
    get_binance("SHIB");
    get_binance("PEPE");
    get_binance("BONK");
    get_binance("FLOKI");
    get_binance("ENA");
    get_binance("ORDI");
    get_binance("1000SATS");
    get_binance("AVA");
    get_binance("SUI");
    get_binance("APT");
    get_binance("ZK");
    get_binance("ALT");
    get_binance("FIL");
    get_binance("BTC");
    get_binance("ETH");
    get_binance("SOL");
    get_binance("RENDER");
    get_binance("OP");
    get_binance("ARB");
    get_binance("FLOW");
    get_binance("PENDLE");
    get_binance("ETHBTC");
    get_binance("FILBTC");
    get_binance("NEXO");
    get_binance("SHIB");

    get_binance("PYTH");
    get_binance("STX");
    get_binance("SSV");
    get_binance("IO");
    get_binance("DOGE");
    get_binance("DOGS");
    //get_binance("BNB");
    get_binance("ZRO");
    get_binance_cmc("OVER", "overprotocol");
    get_binance_cmc("COOKIE", "cookie");
    //get_geckoterminal("0xfb79d843d8d7e38bd5a7f115fa889b043db6fe76"); //MCC
    //get_geckoterminal("0x09ead9122ba8ac230746eb9730d1c099d9a6181d"); //WCC

    //get_binance_cmc("GRASS", "grass");
    //get_sea();
    //get_shark();

    function get_rain() {
        $.getJSON('https://' + CONFIG.MYSITE + '/linepic/rain.json')
            .done(function(data) {
                var hasRain = false;
                if (data.rain_periods && data.rain_periods.length > 0) {
                    for (var i = 0; i < data.rain_periods.length; i++) {
                        var period = data.rain_periods[i];
                        if (period.weather_description && period.weather_description.includes('雨')) {
                            hasRain = true;
                            $('div.rain').css("color", "red");
                            $('div.rain').html(period.time + ' ' + period.weather_description + ' ' + period.probability + '%');
                            break;
                        }
                    }
                }
                if (!hasRain) {
                    $('div.rain').html('');
                }
            })
            .fail(function() {
                console.log('Failed to fetch rain data');
                $('div.rain').html('');
            });
    }

    get_pm25();
    get_weather();
    get_rain();

    // Todoist 漂浮視窗功能
    const TODOIST_API_TOKEN = CONFIG.TODOIST_TOKEN; // 從 config.js 載入 Todoist API Token
    let todoistTasks = [];

    // 要顯示的任務關鍵字
    const TASK_KEYWORDS = ['Fix VPN', 'ToDo', '黑種草', '新表格', 'Check stock changes'];

    // 初始載入 Todoist 任務並顯示圖示
    initTodoistTasks();

    // 初始化 Todoist 任務
    function initTodoistTasks() {
        // 如果沒有設定 API Token，顯示示範資料
        if (TODOIST_API_TOKEN === 'YOUR_TODOIST_API_TOKEN') {
            showDemoTasks();
            return;
        }

        $.ajax({
            url: 'https://api.todoist.com/rest/v2/tasks',
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + TODOIST_API_TOKEN
            },
            success: function (tasks) {
                todoistTasks = tasks;
                displayTasks(tasks);
            },
            error: function (xhr, status, error) {
                console.error('Todoist API 載入失敗:', error);
                // API 載入失敗時不顯示圖示
            }
        });
    }

    // 漂浮視窗控制
    $('#todoistIcon').click(function () {
        const panel = $('#todoistPanel');
        if (panel.is(':visible')) {
            panel.hide();
        } else {
            panel.show();
            loadTodoistTasks();
        }
    });

    $('#todoistClose').click(function () {
        $('#todoistPanel').hide();
    });

    // 點擊視窗外部關閉
    $(document).click(function (event) {
        if (!$(event.target).closest('.todoist-panel, .todoist-float-icon').length) {
            $('#todoistPanel').hide();
        }
    });

    // 載入 Todoist 任務
    function loadTodoistTasks() {
        const content = $('#todoistContent');
        content.html('<div class="todoist-loading">載入中...</div>');

        // 如果沒有設定 API Token，顯示示範資料
        if (TODOIST_API_TOKEN === 'YOUR_TODOIST_API_TOKEN') {
            showDemoTasks();
            return;
        }

        $.ajax({
            url: 'https://api.todoist.com/rest/v2/tasks',
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + TODOIST_API_TOKEN
            },
            success: function (tasks) {
                todoistTasks = tasks;
                displayTasks(tasks);
            },
            error: function (xhr, status, error) {
                content.html('<div class="todoist-error">載入失敗：' + error + '<br><small>請檢查 API Token 是否正確</small></div>');
            }
        });
    }

    // 顯示示範任務（當沒有設定 API Token 時）
    function showDemoTasks() {
        const demoTasks = [
            {
                id: '1',
                content: 'Fix VPN 連線問題',
                project_id: 'work',
                priority: 3,
                due: { date: '2025-07-30' },
                labels: ['技術']
            },
            {
                id: '2',
                content: 'ToDo 清單整理',
                project_id: 'personal',
                priority: 2,
                due: null,
                labels: ['整理']
            },
            {
                id: '3',
                content: '黑種草油補充',
                project_id: 'health',
                priority: 1,
                due: { date: '2025-07-29' },
                labels: ['健康']
            },
            {
                id: '4',
                content: '新表格設計完成',
                project_id: 'work',
                priority: 2,
                due: null,
                labels: ['設計']
            }
        ];

        todoistTasks = demoTasks;
        displayTasks(demoTasks);
    }

    // 顯示任務列表
    function displayTasks(tasks) {
        const content = $('#todoistContent');

        // 過濾只顯示包含特定關鍵字的任務
        const filteredTasks = tasks.filter(task => {
            return TASK_KEYWORDS.some(keyword =>
                task.content.includes(keyword)
            );
        });

        if (filteredTasks.length === 0) {
            content.html('<div class="no-tasks">🎉 沒有相關任務！</div>');
            // 沒有任務時隱藏圖示
            $('#todoistIcon').css('display', 'none');
            return;
        }

        // 有任務時顯示圖示
        $('#todoistIcon').css('display', 'flex');

        // 按優先級和到期日排序
        filteredTasks.sort((a, b) => {
            // 先按優先級排序（數字越大優先級越高）
            if (a.priority !== b.priority) {
                return b.priority - a.priority;
            }

            // 再按到期日排序
            if (a.due && b.due) {
                return new Date(a.due.date) - new Date(b.due.date);
            } else if (a.due) {
                return -1;
            } else if (b.due) {
                return 1;
            }

            return 0;
        });

        let html = '';
        filteredTasks.forEach(task => {
            html += createTaskHTML(task);
        });

        content.html(html);
    }

    // 創建單個任務的 HTML
    function createTaskHTML(task) {
        const priorityClass = `priority-${task.priority}`;
        const priorityText = getPriorityText(task.priority);
        const dueInfo = getDueInfo(task.due);
        const projectName = getProjectName(task.project_id);

        return `
            <div class="task-item" data-task-id="${task.id}">
                <div class="task-title">
                    <a href="https://app.todoist.com/" target="_blank" style="color: inherit; text-decoration: none;">
                        ${escapeHtml(task.content)}
                    </a>
                </div>
                <div class="task-meta">
                    <span class="task-project">${projectName}</span>
                    <div>
                        ${task.priority > 1 ? `<span class="task-priority ${priorityClass}">${priorityText}</span>` : ''}
                        ${dueInfo ? `<span class="task-due ${dueInfo.class}">${dueInfo.text}</span>` : ''}
                    </div>
                </div>
            </div>
        `;
    }

    // 獲取優先級文字
    function getPriorityText(priority) {
        const priorities = {
            4: 'P1',
            3: 'P2',
            2: 'P3',
            1: 'P4'
        };
        return priorities[priority] || '';
    }

    // 獲取到期日資訊
    function getDueInfo(due) {
        if (!due || !due.date) return null;

        const dueDate = new Date(due.date);
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1);

        // 重置時間部分以便比較日期
        today.setHours(0, 0, 0, 0);
        tomorrow.setHours(0, 0, 0, 0);
        dueDate.setHours(0, 0, 0, 0);

        let text = '';
        let className = '';

        if (dueDate < today) {
            text = '已逾期';
            className = 'overdue';
        } else if (dueDate.getTime() === today.getTime()) {
            text = '今天';
            className = '';
        } else if (dueDate.getTime() === tomorrow.getTime()) {
            text = '明天';
            className = '';
        } else {
            text = formatDate(dueDate);
            className = '';
        }

        return { text, class: className };
    }

    // 格式化日期
    function formatDate(date) {
        const month = date.getMonth() + 1;
        const day = date.getDate();
        return `${month}/${day}`;
    }

    // 獲取專案名稱（簡化版本）
    function getProjectName(projectId) {
        const projectNames = {
            'work': '工作',
            'personal': '個人',
            'health': '健康',
            'learning': '學習'
        };
        return projectNames[projectId] || '收件匣';
    }

    // HTML 轉義
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    fetchAndUpdate();
    fetchAndUpdateBTC();
    /* Auto Reload */
    setTimeout(function () { window.location = window.location; }, 300000);
</script>
