<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>信用貸款試算 (Credit Loan Calculator)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
:root {
    /* Bank Theme - Emerald Green / Gold / Professional Grey */
    --primary-color: #008753;
    --primary-hover: #006039;
    --accent-color: #C3A354;
    
    --bg-color: #f1f5f9;
    --card-bg: #ffffff;
    --text-main: #333333;
    --text-muted: #666666;
    --border-color: #e5e5e5;
    
    --success-bg: #ecfdf5;
    --success-text: #059669;

    --font-family: 'Inter', 'Noto Sans TC', sans-serif;
    
    --shadow-soft: 0 4px 20px rgba(0,0,0,0.08);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
    font-family: var(--font-family);
    background-color: var(--bg-color);
    color: var(--text-main);
    line-height: 1.5;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    padding: 40px 20px;
}

.container { width: 100%; max-width: 1000px; }

.header { text-align: center; margin-bottom: 32px; }
.header h1 { font-size: 1.75rem; font-weight: 700; color: var(--text-main); margin-bottom: 4px; }
.header .subtitle { color: var(--text-muted); font-size: 1rem; }

.calculator-card {
    background: var(--card-bg);
    border-radius: 20px;
    box-shadow: var(--shadow-soft);
    padding: 0;
    overflow: hidden;
}

/* Wide Screen Layout */
.calculator-grid {
    display: grid;
    grid-template-columns: 1fr 340px;
    min-height: 500px;
}

.input-section {
    padding: 40px;
    border-right: 1px solid var(--border-color);
}

.result-section {
    padding: 40px;
    background: #f8fafc;
    border-left: 1px solid #fff;
    display: flex;
    flex-direction: column;
}

/* Form Styles */
.form-group { margin-bottom: 24px; }
.form-group label { display: block; font-size: 0.95rem; font-weight: 600; margin-bottom: 8px; color: var(--text-main); }

.input-wrapper { position: relative; display: flex; align-items: center; }
.input-wrapper input {
    width: 100%;
    padding: 12px 16px;
    padding-right: 40px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 1rem;
    color: var(--text-main);
    background: #fff;
    transition: all 0.2s;
    font-family: var(--font-family);
}
.input-wrapper input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(0, 135, 83, 0.1);
}
.input-wrapper .unit {
    position: absolute;
    right: 12px;
    color: var(--text-muted);
    font-size: 0.9rem;
    pointer-events: none;
}

/* Toggles */
.toggle-group {
    display: flex;
    gap: 4px;
    background: #f1f5f9;
    padding: 4px;
    border-radius: 10px;
    flex-wrap: wrap;
}
.toggle-btn {
    flex: 1;
    min-width: 60px;
    padding: 8px 4px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    font-weight: 500;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9rem;
}
.toggle-btn.active {
    background: #fff;
    color: var(--primary-color);
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    font-weight: 600;
    border: 1px solid #e2e8f0;
}

/* Form Row (Two Columns) */
.form-row { display: flex; gap: 20px; margin-bottom: 24px; }
.form-group.half { flex: 1; margin-bottom: 0; }

/* Rate Inputs */
.rate-row {
    background: #fff;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 8px;
    border: 1px solid var(--border-color);
}
.rate-label {
    font-size: 0.85rem;
    color: var(--primary-color);
    margin-bottom: 8px;
    font-weight: 600;
}
.rate-input-group {
    display: flex;
    align-items: center;
    gap: 12px;
}
.text-sm { font-size: 0.9rem; color: var(--text-main); }
.input-sm {
    width: 60px;
    padding: 8px;
    text-align: center;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 0.9rem;
}
.input-wrapper.small input { padding: 8px 30px 8px 10px; font-size: 0.9rem; }

/* Utilities */
.hidden { display: none !important; }
.mt-4 { margin-top: 16px; }
.mt-2 { margin-top: 8px; }

/* Result Section Styling */
.result-section h3 { 
    font-size: 1.1rem; 
    margin-bottom: 24px; 
    color: var(--text-main);
    border-left: 4px solid var(--primary-color);
    padding-left: 12px;
}

.result-summary {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 24px;
}
.summary-item {
    background: #fff;
    padding: 12px 16px;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    border: 1px solid #f1f1f1;
}
.summary-item .label { 
    font-size: 0.85rem; 
    color: var(--text-muted); 
    margin-bottom: 4px;
    white-space: nowrap;
}
.summary-item .value { 
    font-size: 1rem; 
    font-weight: 700; 
    color: var(--text-main);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 100%;
}

.monthly-payment-container {
    background: var(--primary-color);
    color: white;
    border-radius: 16px;
    padding: 24px;
    text-align: center;
    box-shadow: 0 8px 20px rgba(0, 135, 83, 0.2);
    margin-bottom: auto;
}
.monthly-payment-container h4 {
    color: rgba(255,255,255,0.9);
    font-size: 0.9rem;
    margin-bottom: 12px;
    font-weight: 500;
}
.payment-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    padding: 6px 0;
    border-bottom: 1px solid rgba(255,255,255,0.2);
}
.payment-row:last-child { border-bottom: none; }
.payment-row .period { font-size: 0.9rem; color: rgba(255,255,255,0.8); white-space: nowrap; }
.payment-row .amount { font-size: 1.4rem; font-weight: 700; color: #fff; white-space: nowrap; }

.fees-note {
    font-size: 0.8rem;
    color: var(--text-muted);
    text-align: center;
    margin-top: 24px;
}

/* Mobile Responsive */
@media (max-width: 800px) {
    .calculator-grid {
        grid-template-columns: 1fr;
    }
    .input-section { border-right: none; padding: 24px; }
    .result-section { border-left: none; padding: 24px; border-top: 1px solid var(--border-color); }
    .form-row { flex-direction: column; gap: 20px; }
    
    .result-summary { grid-template-columns: 1fr 1fr; }
    .summary-item .value { font-size: 0.95rem; }
}
    </style>
</head>
<body>

<div class="container">
    <header class="header">
        <h1>信用貸款試算</h1>
        <p class="subtitle">本息平均攤還法</p>
    </header>

    <main class="calculator-card">
        <div class="calculator-grid">
            <div class="input-section">
                <!-- 貸款金額 -->
                <div class="form-group">
                    <label for="amount">貸款金額 (TWD)</label>
                    <div class="input-wrapper">
                        <input type="number" id="amount" placeholder="例如：1000000" min="0" step="10000">
                        <span class="unit">元</span>
                    </div>
                </div>

                <!-- 貸款期限 -->
                <div class="form-group">
                    <label>貸款期限</label>
                    <div class="toggle-group" id="term-toggles">
                        <button type="button" class="toggle-btn" data-value="36">36期</button>
                        <button type="button" class="toggle-btn" data-value="60">60期</button>
                        <button type="button" class="toggle-btn active" data-value="84">84期</button>
                        <button type="button" class="toggle-btn" data-value="120">120期</button>
                        <button type="button" class="toggle-btn" data-value="custom">其他</button>
                    </div>
                    <div class="input-wrapper mt-2 hidden" id="term-custom-wrapper">
                        <input type="number" id="term-custom" placeholder="請輸入期數" min="1" max="120">
                        <span class="unit">期 (月)</span>
                    </div>
                </div>

                <!-- 寬限期 & 相關費用 -->
                <div class="form-row">
                    <div class="form-group half">
                        <label for="grace-period">寬限期 (月)</label>
                        <div class="input-wrapper">
                            <input type="number" id="grace-period" min="0" placeholder="0">
                            <span class="unit">月</span>
                        </div>
                    </div>
                    <div class="form-group half">
                        <label for="fees">相關費用 (TWD)</label>
                        <div class="input-wrapper">
                            <input type="number" id="fees" min="0" step="1000" placeholder="0">
                            <span class="unit">元</span>
                        </div>
                    </div>
                </div>

                <!-- 利率計算方式 -->
                <div class="form-group">
                    <label>利率計算方式</label>
                    <div class="toggle-group" id="rate-type-toggles">
                        <button type="button" class="toggle-btn active" data-value="1">一段式</button>
                        <button type="button" class="toggle-btn" data-value="2">二段式</button>
                        <button type="button" class="toggle-btn" data-value="3">三段式</button>
                    </div>
                    
                    <div id="rate-inputs-container" class="mt-4">
                        <!-- Dynamic Rate Inputs will be injected here -->
                    </div>
                </div>
            </div>

            <div class="result-section" id="result-section">
                <h3>試算結果</h3>
                
                <div class="result-summary">
                    <div class="summary-item">
                        <span class="label">年利率</span>
                        <span class="value" id="result-rate">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">期數</span>
                        <span class="value" id="result-term">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">貸款總利息</span>
                        <span class="value" id="total-interest">0 元</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">本息+費用</span>
                        <span class="value" id="total-payment">0 元</span>
                    </div>
                </div>

                <div class="monthly-payment-container">
                    <h4>每月應繳金額</h4>
                    <div id="payment-schedule" class="payment-schedule">
                        <!-- Dynamic payment rows -->
                    </div>
                </div>

                <div class="fees-note" id="fees-note" style="display:none">
                    * 包含相關費用 <span id="fees-display">0</span> 元
                </div>
            </div>
        </div>
    </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // === Elements ===
    const amountInput = document.getElementById('amount');
    
    // Term Elements
    const termToggles = document.getElementById('term-toggles');
    const termCustomWrapper = document.getElementById('term-custom-wrapper');
    const termCustomInput = document.getElementById('term-custom');
    let currentTerm = 84;

    // Grace Period & Fees
    const gracePeriodInput = document.getElementById('grace-period');
    const feesInput = document.getElementById('fees');

    // Rate Type Elements
    const rateTypeToggles = document.getElementById('rate-type-toggles');
    const rateInputsContainer = document.getElementById('rate-inputs-container');
    let currentRateType = 1;

    // Result Elements
    const totalInterestDisplay = document.getElementById('total-interest');
    const totalPaymentDisplay = document.getElementById('total-payment');
    const paymentSchedule = document.getElementById('payment-schedule');
    const feesNote = document.getElementById('fees-note');
    const feesDisplay = document.getElementById('fees-display');

    // === Formatters ===
    const formatNumber = (num) => new Intl.NumberFormat('zh-TW').format(Math.round(num));

    // === Input Sanitization ===
    const sanitizeInput = (e) => {
        let val = e.target.value;
        if (val.length > 1 && val.startsWith('0') && !val.startsWith('0.')) {
            e.target.value = val.replace(/^0+/, '');
        }
        calculate();
    };

    // === Toggle Handlers ===
    
    // Term Toggles
    termToggles.addEventListener('click', (e) => {
        if (e.target.classList.contains('toggle-btn')) {
            termToggles.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');

            const val = e.target.dataset.value;
            if (val === 'custom') {
                termCustomWrapper.classList.remove('hidden');
                currentTerm = parseInt(termCustomInput.value) || 0;
            } else {
                termCustomWrapper.classList.add('hidden');
                currentTerm = parseInt(val);
                renderRateInputs(); 
            }
            calculate();
        }
    });

    termCustomInput.addEventListener('input', (e) => {
        if (!termCustomWrapper.classList.contains('hidden')) {
            currentTerm = parseInt(e.target.value) || 0;
            renderRateInputs();
            calculate();
        }
    });

    // Rate Type Toggles
    rateTypeToggles.addEventListener('click', (e) => {
        if (e.target.classList.contains('toggle-btn')) {
            rateTypeToggles.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');

            currentRateType = parseInt(e.target.dataset.value);
            renderRateInputs();
            calculate();
        }
    });

    // === Render Rate Inputs ===
    const renderRateInputs = () => {
        let html = '';
        
        // Stage 1
        html += createRateRow(1, 1, currentRateType === 1 ? currentTerm : 'X');

        // Stage 2
        if (currentRateType >= 2) {
            html += createRateRow(2, 'X+1', currentRateType === 2 ? currentTerm : 'Y');
        }

        // Stage 3
        if (currentRateType >= 3) {
            html += createRateRow(3, 'Y+1', currentTerm);
        }

        rateInputsContainer.innerHTML = html;
        attachRateInputListeners();
    };

    const createRateRow = (stage, start, end) => {
        let endInputAttr = '';
        let endVal = '';
        
        // Defaults for Ends
        if (stage === 1 && currentRateType > 1) {
            const existingInput = document.querySelector(`.rate-row[data-stage="1"] .month-end-input`);
            endVal = existingInput ? existingInput.value : '6'; 
        }
        if (stage === 2 && currentRateType > 2) {
            const existingInput = document.querySelector(`.rate-row[data-stage="2"] .month-end-input`);
            endVal = existingInput ? existingInput.value : '12';
        }
        if (stage === currentRateType) { 
            endVal = currentTerm; 
            endInputAttr = 'disabled'; 
        }

        return `
            <div class="rate-row" data-stage="${stage}">
                <div class="rate-label">第 ${stage} 段利率</div>
                <div class="rate-input-group">
                    <span class="text-sm">第 ${stage === 1 ? 1 : '<span class="start-month">?</span>'} ~</span>
                    <input type="number" class="month-end-input input-sm" value="${endVal}" ${endInputAttr} min="1">
                    <span class="text-sm">月</span>
                    <div class="input-wrapper small">
                        <input type="number" class="rate-input" placeholder="2.88" value="3.5" step="0.01">
                        <span class="unit">%</span>
                    </div>
                </div>
            </div>
        `;
    };

    const attachRateInputListeners = () => {
        const inputs = rateInputsContainer.querySelectorAll('input');
        inputs.forEach(input => {
            input.addEventListener('input', (e) => {
                sanitizeInput(e);
                updateMonthRanges();
                calculate();
            });
        });
        updateMonthRanges();
    };

    const updateMonthRanges = () => {
        const rows = rateInputsContainer.querySelectorAll('.rate-row');
        let prevEnd = 0;

        rows.forEach((row, index) => {
            const stage = index + 1;
            const startSpan = row.querySelector('.start-month');
            const endInput = row.querySelector('.month-end-input');

            if (startSpan) {
                startSpan.textContent = prevEnd + 1;
            }

            if (stage === currentRateType) {
                endInput.value = currentTerm;
            } else {
                let val = parseInt(endInput.value) || 0;
                if (val <= prevEnd) val = prevEnd + 1;
            }
            prevEnd = parseInt(endInput.value) || prevEnd;
        });
    };

    // === Calculation Logic ===
    const calculate = () => {
        const amount = parseFloat(amountInput.value) || 0;
        const gracePeriod = parseInt(gracePeriodInput.value) || 0;
        const fees = parseFloat(feesInput.value) || 0;
        
        if (amount === 0) {
           resetResult();
           return;
        }

        // Parse Rates
        const stages = [];
        const rows = rateInputsContainer.querySelectorAll('.rate-row');
        let prevEnd = 0;

        rows.forEach(row => {
            const endInput = row.querySelector('.month-end-input');
            const rateInput = row.querySelector('.rate-input');
            
            const endMonth = parseInt(endInput.value) || currentTerm;
            const annualRate = parseFloat(rateInput.value) || 0;
            
            stages.push({
                start: prevEnd + 1,
                end: endMonth,
                rate: annualRate / 100 / 12
            });
            prevEnd = endMonth;
        });

        // Amortization Simulation
        let remainingPrincipal = amount;
        let totalInterest = 0;
        
        // Grouping logic for display
        let groups = [];
        let currentGroup = null;

        for (let m = 1; m <= currentTerm; m++) {
             // Find rate for this month
             let currentStageRate = 0;
             for (let s of stages) {
                 if (m >= s.start && m <= s.end) {
                     currentStageRate = s.rate;
                     break;
                 }
             }

             let pay = 0;
             let interest = 0;
             let principalPay = 0;

             if (m <= gracePeriod) {
                 interest = remainingPrincipal * currentStageRate;
                 pay = interest;
             } else {
                 const restTerm = currentTerm - m + 1;
                 if (currentStageRate === 0) {
                     pay = remainingPrincipal / restTerm;
                 } else {
                     pay = (remainingPrincipal * currentStageRate * Math.pow(1 + currentStageRate, restTerm)) / (Math.pow(1 + currentStageRate, restTerm) - 1);
                 }
                 interest = remainingPrincipal * currentStageRate;
                 principalPay = pay - interest;
             }

             remainingPrincipal -= principalPay;
             totalInterest += interest;
             
             const roundedPay = Math.round(pay);

             if (currentGroup && currentGroup.amount === roundedPay) {
                 currentGroup.end = m;
             } else {
                 if (currentGroup) groups.push(currentGroup);
                 currentGroup = { start: m, end: m, amount: roundedPay };
             }
        }
        if (currentGroup) groups.push(currentGroup);

        // Update Result UI
        
        // Rate Display Logic
        let rateDisplayStr = '';
        if (stages.length === 1) {
            rateDisplayStr = (stages[0].rate * 12 * 100).toFixed(2) + ' %';
        } else {
            const rates = stages.map(s => s.rate * 12 * 100);
            const minRate = Math.min(...rates).toFixed(2);
            const maxRate = Math.max(...rates).toFixed(2);
            if (minRate === maxRate) {
                rateDisplayStr = minRate + ' %';
            } else {
                rateDisplayStr = `${minRate} % ~ ${maxRate} %`;
            }
        }
        document.getElementById('result-rate').textContent = rateDisplayStr;
        document.getElementById('result-term').textContent = currentTerm + " 期";
        
        totalInterestDisplay.textContent = formatNumber(totalInterest) + " 元";
        totalPaymentDisplay.textContent = formatNumber(amount + totalInterest + fees) + " 元";
        
        let scheduleHtml = '';
        groups.forEach(g => {
            scheduleHtml += `
            <div class="payment-row">
                <span class="period">第 ${g.start} ~ ${g.end} 期</span>
                <span class="amount">${formatNumber(g.amount)} 元</span>
            </div>`;
        });
        paymentSchedule.innerHTML = scheduleHtml;

        if (fees > 0) {
            feesNote.style.display = 'block';
            feesDisplay.textContent = formatNumber(fees);
        } else {
            feesNote.style.display = 'none';
        }
    };

    const resetResult = () => {
        document.getElementById('result-rate').textContent = "-";
        document.getElementById('result-term').textContent = "-";
        totalInterestDisplay.textContent = "0 元";
        totalPaymentDisplay.textContent = "0 元";
        paymentSchedule.innerHTML = `
            <div class="payment-row">
                <span class="period">第 1 ~ ${currentTerm} 期</span>
                <span class="amount">0 元</span>
            </div>`;
    };

    // Attach listeners
    [amountInput, gracePeriodInput, feesInput].forEach(inp => {
        inp.addEventListener('input', sanitizeInput);
    });

    // Initial Render and Calculate
    renderRateInputs();
    calculate(); // Auto-calculate on page load
});
</script>
</body>
</html>
